<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>六獸×六親×地支｜API 測試表單</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-3xl mx-auto p-6 space-y-4">
    <h1 class="text-2xl font-bold">六獸×六親×地支｜API 測試表單</h1>

    <!-- API 位置 -->
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <label class="block text-sm mb-1 text-slate-600">API 基底（留空＝使用同網域 /api/analyze）</label>
      <input id="apiBase" class="w-full border rounded-lg p-2" placeholder="例如：https://567-lac.vercel.app/api/analyze" />
      <p class="text-xs mt-1 text-slate-500">若把這頁部署和 API 同一個 Vercel 專案，這欄可留空，系統會用 <code>/api/analyze</code>。</p>
    </div>

    <!-- 模式切換 -->
    <div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-3">
      <label class="flex items-center gap-2 text-sm">
        <input id="singleMode" type="checkbox" class="w-4 h-4" checked />
        單方分析（不選對方）
      </label>
      <label class="flex items-center gap-2 text-sm">
        <input id="deepMode" type="checkbox" class="w-4 h-4" />
        進階深入分析
      </label>
      <span id="status" class="text-sm text-slate-500"></span>
    </div>

    <!-- 我方 -->
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <h2 class="font-semibold mb-3">我方</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <select id="aBeast" class="border rounded-lg p-2">
          <option value="">六獸</option>
          <option>青龍</option><option>朱雀</option><option>勾陳</option>
          <option>螣蛇</option><option>白虎</option><option>玄武</option>
        </select>
        <select id="aKin" class="border rounded-lg p-2">
          <option value="">六親</option>
          <option>父母</option><option>兄弟</option><option>子孫</option>
          <option>妻財</option><option>官鬼</option>
        </select>
        <select id="aBranch" class="border rounded-lg p-2">
          <option value="">地支</option>
          <option>子</option><option>丑</option><option>寅</option><option>卯</option>
          <option>辰</option><option>巳</option><option>午</option><option>未</option>
          <option>申</option><option>酉</option><option>戌</option><option>亥</option>
        </select>
      </div>
    </div>

    <!-- 對方 -->
    <div id="bPanel" class="bg-white p-4 rounded-xl shadow-sm">
      <h2 class="font-semibold mb-3">對方（僅雙方分析需要）</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <select id="bBeast" class="border rounded-lg p-2">
          <option value="">六獸</option>
          <option>青龍</option><option>朱雀</option><option>勾陳</option>
          <option>螣蛇</option><option>白虎</option><option>玄武</option>
        </select>
        <select id="bKin" class="border rounded-lg p-2">
          <option value="">六親</option>
          <option>父母</option><option>兄弟</option><option>子孫</option>
          <option>妻財</option><option>官鬼</option>
        </select>
        <select id="bBranch" class="border rounded-lg p-2">
          <option value="">地支</option>
          <option>子</option><option>丑</option><option>寅</option><option>卯</option>
          <option>辰</option><option>巳</option><option>午</option><option>未</option>
          <option>申</option><option>酉</option><option>戌</option><option>亥</option>
        </select>
      </div>
    </div>

    <!-- 情境 -->
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <h2 class="font-semibold mb-2">情境</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">年度目標協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">績效回饋會議</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">跨部門協作</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">壓期交付專案</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">人際關係協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">愛情</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">性愛</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="輸入情境…（例：升遷準備、與 A 同事協作、親密關係）" />
    </div>

    <!-- 操作 -->
    <div class="flex flex-wrap gap-3">
      <button id="btnDry" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">乾測（dry=1）</button>
      <button id="btnSend" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">送出分析</button>
    </div>

    <!-- 結果 -->
    <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
      <div><span class="text-sm text-slate-500">每日一句：</span><span id="enc" class="text-emerald-700 font-medium"></span></div>
      <pre id="text" class="whitespace-pre-wrap text-[13.5px] leading-6"></pre>
      <div>
        <h3 class="font-semibold">JSON 區塊（若有）</h3>
        <pre id="jsonOut" class="bg-slate-50 p-3 rounded-lg overflow-auto text-[13px]"></pre>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);

    // 切換單方/雙方
    $('#singleMode').addEventListener('change', ()=>{
      const on = $('#singleMode').checked;
      $('#bPanel').classList.toggle('hidden', on);
    });
    // 預設單方
    $('#bPanel').classList.add('hidden');

    // 快速帶入情境
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.preset');
      if(!btn) return;
      e.preventDefault();
      $('#context').value = btn.textContent.trim();
    });

    function getApiUrl() {
      const base = ($('#apiBase').value || '').trim();
      return base || '/api/analyze';
    }
    function getPayload() {
      const single = $('#singleMode').checked;
      const payload = {
        aBeast: $('#aBeast').value,
        aKin: $('#aKin').value,
        aBranch: $('#aBranch').value,
        context: $('#context').value.trim(),
        depth: $('#deepMode').checked ? 'deep' : 'basic',
        mode: single ? 'single' : 'pair'
      };
      if(!single){
        payload.bBeast = $('#bBeast').value;
        payload.bKin = $('#bKin').value;
        payload.bBranch = $('#bBranch').value;
      }
      return payload;
    }

    function parseJsonBlock(text){
      const m = typeof text === 'string' && text.match(/```json([\\s\\S]*?)```/i);
      if(!m) return null;
      try { return JSON.parse(m[1]); } catch(_) { return null; }
    }

    async function dryTest(){
      $('#status').textContent = '呼叫中（dry）…';
      $('#enc').textContent = '';
      $('#text').textContent = '';
      $('#jsonOut').textContent = '';
      try{
        // 乾測用 GET
        const base = getApiUrl();
        const url = base.includes('?') ? base + '&dry=1&mode=single' : base + '?dry=1&mode=single';
        const r = await fetch(url);
        const data = await r.json();
        $('#text').textContent = data.text || JSON.stringify(data,null,2);
        const block = parseJsonBlock(data.text);
        if(block){
          $('#jsonOut').textContent = JSON.stringify(block,null,2);
          $('#enc').textContent = block.encourage || '';
        }
        $('#status').textContent = '✅ 結束（dry）';
      }catch(e){
        $('#status').textContent = '❌ ' + (e.message || e);
      }
    }

    async function send(){
      const p = getPayload();
      const single = p.mode === 'single';
      if(!(p.aBeast && p.aKin && p.aBranch && p.context)){
        alert('請先選滿「我方：六獸、六親、地支」與「情境」。');
        return;
      }
      if(!single && !(p.bBeast && p.bKin && p.bBranch)){
        alert('雙方模式請把「對方：六獸、六親、地支」也選滿。');
        return;
      }

      $('#status').textContent = '呼叫中…';
      $('#enc').textContent = '';
      $('#text').textContent = '';
      $('#jsonOut').textContent = '';

      try{
        const r = await fetch(getApiUrl(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(p)
        });
        const raw = await r.text();
        let data; try{ data = JSON.parse(raw); }catch{ data = { raw }; }

        if(!r.ok){
          throw new Error((data && data.error && data.error.message) || data.raw || ('HTTP '+r.status));
        }

        const txt = data.text || data.result || data.message || raw;
        $('#text').textContent = txt;

        const block = parseJsonBlock(txt);
        if(block){
          $('#jsonOut').textContent = JSON.stringify(block,null,2);
          $('#enc').textContent = block.encourage || '';
        }
        $('#status').textContent = '✅ 成功';
      }catch(e){
        $('#status').textContent = '❌ ' + (e.message || e);
      }
    }

    $('#btnDry').onclick = dryTest;
    $('#btnSend').onclick = send;
  </script>
</body>
</html>
