<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格｜一鍵分析</title>
  <!-- 你已在用 Tailwind 可保留；沒有也不影響 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js 4.x：雷達圖用得到 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="p-4">
  <!-- 性愛情境勾選（示例，id/name 請跟下面 JS 對齊） -->
  <div class="mb-4 space-y-2">
    <label class="flex items-center gap-2">
      <input id="sex-toggle" type="checkbox" class="scale-125">
      <span class="font-semibold">性愛情境深入分析</span>
    </label>
    <div class="grid grid-cols-2 gap-2 pl-6 text-sm">
      <label><input type="checkbox" name="sexTags" value="前奏與默契"> 前奏與默契</label>
      <label><input type="checkbox" name="sexTags" value="博弈與風險"> 博弈與風險</label>
      <label><input type="checkbox" name="sexTags" value="溫柔引導"> 溫柔引導</label>
      <label><input type="checkbox" name="sexTags" value="界線與善後"> 界線與善後</label>
    </div>
  </div>

  <!-- 其他必要欄位（示例）：請換成你實際的選單/輸入 -->
  <div class="mb-4 grid grid-cols-2 gap-3">
    <input id="aBeast" placeholder="我方六獸（例：青龍）" class="border p-2">
    <input id="aKin" placeholder="我方六親（例：父母）" class="border p-2">
    <input id="aBranch" placeholder="我方地支（例：巳）" class="border p-2">
    <select id="mode" class="border p-2">
      <option value="single">單人</option>
      <option value="double">雙人</option>
    </select>

    <input id="bBeast" placeholder="對方六獸（雙人時必填）" class="border p-2">
    <input id="bKin" placeholder="對方六親" class="border p-2">
    <input id="bBranch" placeholder="對方地支" class="border p-2">
    <input id="context" placeholder="情境描述（選填）" class="border p-2">
  </div>

  <button onclick="runAnalyze()" class="px-4 py-2 bg-black text-white rounded">一鍵分析</button>

  <h3 class="mt-6 text-lg font-bold">分析結果</h3>
  <pre id="report" class="whitespace-pre-wrap leading-relaxed p-3 border rounded min-h-[200px]"></pre>

  <h3 class="mt-6 text-lg font-bold">六維度雷達圖</h3>
  <canvas id="radarChart" width="420" height="420"></canvas>

<script>
  // —— 1) 收集核心欄位（示例：依你實際 UI 替換）——
  function collectCoreFields() {
    const $ = (id) => document.getElementById(id)?.value?.trim();
    return {
      mode: document.getElementById('mode')?.value || 'single',
      aBeast: $('aBeast'),
      aKin: $('aKin'),
      aBranch: $('aBranch'),
      bBeast: $('bBeast'),
      bKin: $('bKin'),
      bBranch: $('bBranch'),
      context: $('context') || ''
    };
  }

  // —— 2) 收集性愛勾選 —— 
  function collectSexDetail() {
    const sexDetail = !!document.querySelector('#sex-toggle')?.checked;
    const sexTags = Array.from(document.querySelectorAll('input[name="sexTags"]:checked'))
      .map(el => el.value);
    return { sexDetail, sexTags };
  }

  // —— 3) 呼叫 API 並渲染 —— 
  async function runAnalyze() {
    const { mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch, context } = collectCoreFields();
    const { sexDetail, sexTags } = collectSexDetail();

    // 基本驗證
    if (!aBeast || !aKin || !aBranch) {
      alert("請先填好我方：六獸／六親／地支");
      return;
    }
    if (mode === 'double' && (!bBeast || !bKin || !bBranch)) {
      alert("雙人模式請填好對方：六獸／六親／地支");
      return;
    }

    const body = {
      mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch, context,
      sexDetail, sexTags
    };

    const res = await fetch("/api/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    // 防止 500 回 HTML 時直接 json() 爆 "<"
    if (!res.ok) {
      const errText = await res.text();
      console.error("Server error:", errText);
      alert("後端錯誤，請開啟 F12 → Console 查看訊息");
      return;
    }

    const data = await res.json(); // { text }
    renderReportText(data?.text ?? "");
  }

  // —— 4) 顯示全文 & 解析 JSON 畫雷達 —— 
  let radarChartInstance = null;

  function renderReportText(text) {
    // (a) 先把完整文字塞進 <pre>
    const pre = document.getElementById('report');
    pre.textContent = text || "(無內容)";

    // (b) 從文末擷取 ```json 區塊
    // 允許多行、前後空白；不貪心匹配第一個區塊
    const m = text.match(/```json\s*([\s\S]*?)\s*```/i);
    if (!m) {
      // 沒抓到 JSON：清空圖表
      destroyRadar();
      return;
    }

    let parsed;
    try {
      parsed = JSON.parse(m[1]);
    } catch (e) {
      console.warn("JSON 區塊解析失敗：", e);
      destroyRadar();
      return;
    }

    const scores = parsed?.scores || {};
    drawRadar(scores);
  }

  function destroyRadar() {
    if (radarChartInstance) {
      radarChartInstance.destroy();
      radarChartInstance = null;
    }
    const ctx = document.getElementById('radarChart').getContext('2d');
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  }

  function drawRadar(scores) {
    const labels = ["fit","comm","pace","account","trust","innov"];
    const dataVals = labels.map(k => {
      const v = Number(scores?.[k] ?? 0);
      return isFinite(v) ? Math.max(0, Math.min(100, v)) : 0;
    });

    // 每次重畫前先銷毀舊圖，避免報錯
    destroyRadar();

    const ctx = document.getElementById('radarChart').getContext('2d');
    radarChartInstance = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ["適配度","溝通","節奏","責任/紀律","信任","創新"],
        datasets: [{
          label: '六維度評分 (0~100)',
          data: dataVals,
          fill: true
        }]
      },
      options: {
        responsive: false, // 這裡用固定寬高；若要自適應可改 true 並拿掉 canvas width/height
        scales: {
          r: {
            suggestedMin: 0,
            suggestedMax: 100,
            ticks: { stepSize: 20, showLabelBackdrop: false }
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true }
        }
      }
    });
  }
</script>
</body>
</html>
