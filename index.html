<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格｜一鍵分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="p-6 space-y-6">
  <!-- 性愛情境勾選 -->
  <div>
    <label class="flex items-center gap-2 font-bold">
      <input id="sex-toggle" type="checkbox" class="scale-125">
      性愛情境深入分析
    </label>
    <div class="grid grid-cols-2 gap-2 pl-6 text-sm mt-2">
      <label><input type="checkbox" name="sexTags" value="前奏與默契"> 前奏與默契</label>
      <label><input type="checkbox" name="sexTags" value="博弈與風險"> 博弈與風險</label>
      <label><input type="checkbox" name="sexTags" value="溫柔引導"> 溫柔引導</label>
      <label><input type="checkbox" name="sexTags" value="界線與善後"> 界線與善後</label>
    </div>
  </div>

  <!-- 基本欄位 -->
  <div class="grid grid-cols-2 gap-3">
    <input id="aBeast" placeholder="我方六獸（例：青龍）" class="border p-2">
    <input id="aKin" placeholder="我方六親（例：父母）" class="border p-2">
    <input id="aBranch" placeholder="我方地支（例：巳）" class="border p-2">
    <select id="mode" class="border p-2">
      <option value="single">單人</option>
      <option value="double">雙人</option>
    </select>
    <input id="bBeast" placeholder="對方六獸" class="border p-2">
    <input id="bKin" placeholder="對方六親" class="border p-2">
    <input id="bBranch" placeholder="對方地支" class="border p-2">
    <input id="context" placeholder="情境描述（選填）" class="border p-2">
  </div>

  <button onclick="runAnalyze()" class="px-4 py-2 bg-black text-white rounded">一鍵分析</button>

  <h3 class="text-lg font-bold">分析結果</h3>
  <pre id="report" class="whitespace-pre-wrap leading-relaxed p-3 border rounded min-h-[200px]"></pre>

  <h3 class="text-lg font-bold">六維度雷達圖</h3>
  <canvas id="radarChart" width="420" height="420"></canvas>

<script>
  function collectCoreFields() {
    const $ = (id) => document.getElementById(id)?.value?.trim();
    return {
      mode: document.getElementById('mode')?.value || 'single',
      aBeast: $('aBeast'),
      aKin: $('aKin'),
      aBranch: $('aBranch'),
      bBeast: $('bBeast'),
      bKin: $('bKin'),
      bBranch: $('bBranch'),
      context: $('context') || ''
    };
  }

  function collectSexDetail() {
    const sexDetail = !!document.querySelector('#sex-toggle')?.checked;
    const sexTags = Array.from(document.querySelectorAll('input[name="sexTags"]:checked'))
      .map(el => el.value);
    return { sexDetail, sexTags };
  }

  async function runAnalyze() {
    const { mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch, context } = collectCoreFields();
    const { sexDetail, sexTags } = collectSexDetail();

    if (!aBeast || !aKin || !aBranch) {
      alert("請填好我方：六獸／六親／地支");
      return;
    }
    if (mode === 'double' && (!bBeast || !bKin || !bBranch)) {
      alert("雙人模式請填好對方：六獸／六親／地支");
      return;
    }

    const body = { mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch, context, sexDetail, sexTags };

    const res = await fetch("/api/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const errText = await res.text();
      console.error("Server error:", errText);
      alert("後端錯誤，請看 Console");
      return;
    }

    const data = await res.json();
    renderReportText(data?.text ?? "");
  }

  let radarChartInstance = null;

  function renderReportText(text) {
    document.getElementById('report').textContent = text || "(無內容)";

    // 抓最後一個 JSON 區塊
    const matches = [...text.matchAll(/```json\s*([\s\S]*?)\s*```/gi)];
    if (!matches.length) {
      destroyRadar();
      return;
    }
    const jsonBlock = matches[matches.length - 1][1];

    let parsed;
    try {
      parsed = JSON.parse(jsonBlock);
    } catch (e) {
      console.error("JSON.parse 失敗：", jsonBlock);
      destroyRadar();
      return;
    }
    drawRadar(parsed?.scores || {});
  }

  function destroyRadar() {
    if (radarChartInstance) {
      radarChartInstance.destroy();
      radarChartInstance = null;
    }
    const ctx = document.getElementById('radarChart').getContext('2d');
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  }

  function drawRadar(scores) {
    const labels = ["fit","comm","pace","account","trust","innov"];
    const dataVals = labels.map(k => {
      const v = Number(scores?.[k] ?? 0);
      return isFinite(v) ? Math.max(0, Math.min(100, v)) : 0;
    });

    destroyRadar();
    const ctx = document.getElementById('radarChart').getContext('2d');
    radarChartInstance = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ["適配度","溝通","節奏","責任/紀律","信任","創新"],
        datasets: [{
          label: '六維度評分',
          data: dataVals,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          r: { min: 0, max: 100, ticks: { stepSize: 20 } }
        }
      }
    });
  }
</script>
</body>
</html>
