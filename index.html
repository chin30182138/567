<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>神獸七十二型人格｜分析系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    @media print {
      @page { margin: 14mm; }
      .no-print { display: none !important; }
      body { background: #fff !important; } /* 列印時移除背景 */
    }
    body {
        transition: background-color 0.3s ease, background-image 0.3s ease; /* 添加平滑過渡 */
    }
    .card { background: #fff; border-radius: 12px; padding: 16px; margin-top: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .score { display: flex; align-items: center; gap: 10px; font-size: 13px; margin: 6px 0; }
    .bar { flex: 1; height: 10px; background: #e2e8f0; border-radius: 9999px; overflow: hidden; }
    .bar > i { display: block; height: 100%; }
    /* 為模式切換按鈕添加樣式，確保選中狀態明顯 */
    .mode-button.active {
        background-color: #4f46e5; /* indigo-600 */
        color: white;
    }
    .mode-button:not(.active) {
        background-color: #e2e8f0; /* slate-200 */
        color: #475569; /* slate-800 */
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">神獸七十二型人格｜分析系統</h1>
      <p class="text-slate-500 text-sm">單人 / 雙人分析，支援性愛與個性模式，含分數條、雷達圖、背景上傳與列印。</p>
    </header>

    <!-- 模式切換 -->
    <div class="no-print flex gap-4">
      <button id="modeSingle" class="mode-button px-4 py-2 rounded-xl">單人分析</button>
      <button id="modeDual" class="mode-button px-4 py-2 rounded-xl">雙人分析</button>
    </div>

    <!-- 選擇區 -->
    <div class="grid md:grid-cols-2 gap-4 no-print">
      <!-- 我方 -->
      <section class="bg-white p-4 rounded-2xl shadow-sm">
        <h2 class="font-semibold mb-3">我方</h2>
        <select id="aBeast" class="w-full mb-2 border rounded-lg p-2">
          <option value="">六獸</option>
          <option>青龍</option><option>朱雀</option><option>勾陳</option>
          <option>螣蛇</option><option>白虎</option><option>玄武</option>
        </select>
        <select id="aKin" class="w-full mb-2 border rounded-lg p-2">
          <option value="">六親</option>
          <option>父母</option><option>兄弟</option><option>子孫</option>
          <option>妻財</option><option>官鬼</option>
        </select>
        <select id="aBranch" class="w-full border rounded-lg p-2">
          <option value="">地支</option>
          <option>子</option><option>丑</option><option>寅</option><option>卯</option>
          <option>辰</option><option>巳</option><option>午</option><option>未</option>
          <option>申</option><option>酉</option><option>戌</option><option>亥</option>
        </select>
      </section>

      <!-- 對方 -->
      <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
        <h2 class="font-semibold mb-3">對方</h2>
        <select id="bBeast" class="w-full mb-2 border rounded-lg p-2">
          <option value="">六獸</option>
          <option>青龍</option><option>朱雀</option><option>勾陳</option>
          <option>螣蛇</option><option>白虎</option><option>玄武</option>
        </select>
        <select id="bKin" class="w-full mb-2 border rounded-lg p-2">
          <option value="">六親</option>
          <option>父母</option><option>兄弟</option><option>子孫</option>
          <option>妻財</option><option>官鬼</option>
        </select>
        <select id="bBranch" class="w-full border rounded-lg p-2">
          <option value="">地支</option>
          <option>子</option><option>丑</option><option>寅</option><option>卯</option>
          <option>辰</option><option>巳</option><option>午</option><option>未</option>
          <option>申</option><option>酉</option><option>戌</option><option>亥</option>
        </select>
      </section>
    </div>

    <!-- 情境 -->
    <section class="bg-white p-4 rounded-2xl shadow-sm no-print">
      <h2 class="font-semibold mb-2">情境</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">年度目標協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">績效回饋會議</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">跨部門協作</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">壓期交付專案</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">人際關係協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-red-100 text-red-700">性愛</button> <!-- 性愛按鈕文字顏色調整 -->
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="輸入情境…" />
    </section>

    <!-- 動作列 -->
    <div class="no-print flex flex-wrap items-center gap-3">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">一鍵分析</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">列印 / PDF</button>
      <label class="px-3 py-2 rounded-lg bg-slate-200 text-slate-700 cursor-pointer">
        匯入背景圖片
        <input type="file" id="bgImg" accept="image/*" class="hidden">
      </label>
      <input type="color" id="bgColor" class="w-10 h-10 rounded" value="#f8fafc" /> <!-- 設置預設顏色 -->
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- 結果 -->
    <section id="result" class="space-y-4"></section>
    <div id="scoresWrap"></div>
    <div id="chart" class="mt-4"></div>
  </div>

<script>
// 輔助函式，避免重複寫 document.querySelector
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// 全局變數
let analysisMode = 'dual'; // 預設為雙人分析
let themeColor = '#6366f1'; // 預設主題色

// DOM 元素快取 (提高效率和可讀性)
const D = {
  modeSingle: $('#modeSingle'),
  modeDual: $('#modeDual'),
  sectionB: $('#sectionB'),
  aBeast: $('#aBeast'),
  aKin: $('#aKin'),
  aBranch: $('#aBranch'),
  bBeast: $('#bBeast'),
  bKin: $('#bKin'),
  bBranch: $('#bBranch'),
  context: $('#context'),
  goButton: $('#go'),
  printButton: $('#print'),
  bgImgInput: $('#bgImg'),
  bgColorInput: $('#bgColor'),
  statusSpan: $('#status'),
  resultSection: $('#result'),
  scoresWrap: $('#scoresWrap'),
  chartDiv: $('#chart'),
  presetButtons: $$('.preset'),
  modeButtons: $$('.mode-button'),
};

// 分析模式切換
function setAnalysisMode(mode) {
  analysisMode = mode;
  if (mode === 'single') {
    D.sectionB.style.display = 'none';
  } else {
    D.sectionB.style.display = 'block';
  }

  // 更新按鈕樣式
  D.modeButtons.forEach(btn => btn.classList.remove('active'));
  if (mode === 'single') {
    D.modeSingle.classList.add('active');
  } else {
    D.modeDual.classList.add('active');
  }
}

// 綁定模式切換事件
D.modeSingle.onclick = () => setAnalysisMode('single');
D.modeDual.onclick = () => setAnalysisMode('dual');

// 預設情境按鈕
D.presetButtons.forEach(b => b.onclick = () => D.context.value = b.textContent);

// 分數條渲染
function renderScores(scores) {
  const clamp = v => Math.max(0, Math.min(100, Number(v) || 0)); // 確保分數在 0-100 之間
  const row = (label, key, color) => `
    <div class="score"><b class="w-24">${label}</b>
      <div class="bar"><i style="width:${clamp(scores[key])}%;background:${color}"></i></div>
      <em class="w-10 text-right">${clamp(scores[key])}</em>
    </div>`;

  D.scoresWrap.innerHTML = `
    <div class="card">
      <h3 class="font-semibold mb-2">六維度分數</h3>
      ${row('契合 fit', 'fit', '#22c55e')}
      ${row('溝通 comm', 'comm', '#06b6d4')}
      ${row('節奏 pace', 'pace', '#f59e0b')}
      ${row('權責 account', 'account', '#8b5cf6')}
      ${row('信任 trust', 'trust', '#ef4444')}
      ${row('創新 innov', 'innov', '#6366f1')}
    </div>`;
}

// 雷達圖渲染
let radarChart = null; // 儲存 Chart 實例，以便銷毀和更新
function renderRadar(scores) {
  const clamp = v => Math.max(0, Math.min(100, Number(v) || 0));
  const labels = ['契合', '溝通', '節奏', '權責', '信任', '創新'];
  const data = [
    clamp(scores.fit), clamp(scores.comm), clamp(scores.pace),
    clamp(scores.account), clamp(scores.trust), clamp(scores.innov)
  ];

  D.chartDiv.innerHTML = ''; // 清空之前的圖表
  const canvas = document.createElement('canvas');
  D.chartDiv.appendChild(canvas);

  if (radarChart) {
    radarChart.destroy(); // 銷毀舊圖表
  }

  radarChart = new Chart(canvas.getContext('2d'), {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [{
        label: '六維度雷達圖',
        data: data,
        fill: true,
        backgroundColor: 'rgba(99,102,241,0.15)',
        borderColor: themeColor,
        pointBackgroundColor: themeColor,
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: themeColor
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true, // 保持寬高比
      scales: {
        r: {
          min: 0,
          max: 100,
          ticks: {
            stepSize: 20, // 刻度間距
            backdropColor: 'rgba(255, 255, 255, 0.75)' // 刻度背景色
          },
          angleLines: {
            color: '#e2e8f0' // 角度線顏色
          },
          grid: {
            color: '#cbd5e1' // 網格線顏色
          },
          pointLabels: {
            font: {
              size: 14 // 標籤字體大小
            },
            color: '#334155' // 標籤顏色
          }
        }
      },
      plugins: {
        legend: {
          display: false // 不顯示圖例
        },
        tooltip: {
            callbacks: {
                label: function(context) {
                    return context.dataset.label + ': ' + context.raw;
                }
            }
        }
      }
    }
  });
}

// 渲染分析結果
function renderResult(data) {
  let html = '';
  if (data.sections && data.sections.length > 0) {
    data.sections.forEach(sec => {
      if (sec.items && sec.items.length > 0) {
        html += `
          <div class="card">
            <h4 class="font-semibold mb-2" style="color:${themeColor}">${sec.title}</h4>
            <ul class="list-disc pl-6 space-y-1 text-slate-700">${sec.items.map(i => `<li>${i}</li>`).join('')}</ul>
          </div>`;
      } else if (sec.content) {
        html += `
          <div class="card">
            <h4 class="font-semibold mb-2" style="color:${themeColor}">${sec.title}</h4>
            <p class="text-slate-700 leading-relaxed">${sec.content.replace(/\n/g, '<br>')}</p>
          </div>`;
      }
    });
  } else {
    html = `<div class="card"><p class="text-slate-700">${data.text || '無輸出'}</p></div>`;
  }
  D.resultSection.innerHTML = html;
  if (data.scores) {
    renderScores(data.scores);
    renderRadar(data.scores);
  }
}

// 模擬 API 數據 (保持不變，用於前端獨立執行)
async function fakeApi() {
  // 模擬延遲
  await new Promise(resolve => setTimeout(resolve, 800));
  return {
    text: "朱雀子 × 青龍午 - 火焰與穩重的碰撞",
    sections: [
      { title: "情愛指數", content: "8.5/10 熱情與穩定兼具" },
      { title: "互動模式", content: "朱雀子熱烈主動，青龍午穩重包容。\n這是一個動靜皆宜的組合。" }, // 添加換行測試
      { title: "雷點分析", items: ["朱雀過於急躁，容易忽略青龍的感受", "青龍過於保守，可能讓朱雀感到無趣"] },
      { title: "最佳性愛劇本推薦", items: ["挑逗對決：以輕柔的挑逗開啟，逐漸升溫", "溫柔調情：注重情感交流和前戲", "快速激情戰：在特定時刻爆發的熱情"] },
      { title: "推薦體位", items: ["蓮花交合：深度連結，情感交流", "後背擁抱：親密無間，舒適安心", "交錯纏繞：增加身體接觸和刺激"] },
      { title: "推薦玩具", items: ["羽毛挑逗器：增加輕柔的感官刺激", "熱感按摩油：提升情慾，舒緩身心", "智能震動器：探索不同頻率和強度"] },
      { title: "推薦性愛場景", items: ["溫泉池畔：自然浪漫，親密無間", "高樓露臺：刺激感官，俯瞰城市夜景", "舞蹈室鏡前：探索身體，增加視覺刺激"] }
    ],
    scores: { fit: 80, comm: 70, pace: 65, account: 72, trust: 68, innov: 85 }
  };
}

// 一鍵分析事件處理
D.goButton.onclick = async () => {
  D.statusSpan.textContent = '分析中…';
  D.resultSection.innerHTML = '';
  D.scoresWrap.innerHTML = '';
  D.chartDiv.innerHTML = '';

  try {
    // 這裡可以加入表單驗證，確保所有下拉選單都有選擇值
    const requiredInputs = [D.aBeast, D.aKin, D.aBranch];
    if (analysisMode === 'dual') {
        requiredInputs.push(D.bBeast, D.bKin, D.bBranch);
    }
    const allSelected = requiredInputs.every(select => select.value !== '');

    if (!allSelected) {
        throw new Error('請選擇所有我方/對方的人格參數！');
    }

    const data = await fakeApi(); // ⚠️ 之後替換成 fetch('/api/analyze', { ... })
    renderResult(data);
    D.statusSpan.textContent = '✅ 完成';
  } catch (e) {
    D.statusSpan.textContent = `❌ 失敗: ${e.message || e}`;
    D.resultSection.innerHTML = `<div class="card bg-red-100 text-red-800 p-4 rounded-xl shadow-sm"><p class="font-bold">錯誤！</p><p>${e.message || '未知錯誤'}</p></div>`;
  }
};

// 列印功能
D.printButton.onclick = () => {
  const w = window.open('', '_blank');
  const chartImg = (radarChart && radarChart.canvas) ? radarChart.canvas.toDataURL('image/png') : '';

  // 為了列印頁面更簡潔，移除背景圖片和顏色
  const printBodyStyle = `
    body {
      font-family: sans-serif;
      padding: 20px;
      color: #333;
      background: none !important; /* 強制移除背景 */
      background-image: none !important; /* 強制移除背景圖片 */
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      box-shadow: none; /* 列印時移除陰影 */
    }
    ul { margin: 0 0 0 20px; list-style-type: disc; }
    h1, h2, h3, h4 { color: #333 !important; } /* 確保標題顏色 */
    p { line-height: 1.6; }
    .score { display: flex; align-items: center; gap: 10px; font-size: 13px; margin: 6px 0; }
    .bar { flex: 1; height: 10px; background: #e2e8f0; border-radius: 9999px; overflow: hidden; }
    .bar > i { display: block; height: 100%; }
    .w-24 { width: 96px; }
    .w-10 { width: 40px; }
    .text-right { text-align: right; }
    img { max-width: 100%; height: auto; }
  `;

  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>神獸七十二型人格｜分析報告</title>
    <style>${printBodyStyle}</style></head><body>
    <h1>神獸七十二型人格｜分析報告</h1>
    ${D.resultSection.innerHTML}
    ${D.scoresWrap.innerHTML}
    ${chartImg ? `<div><h3 style="margin-top:20px;">雷達圖</h3><img src="${chartImg}" style="max-width:500px; display:block; margin: 0 auto;"></div>` : ''}
    <script>window.onload=()=>window.print()</script></body></html>`);
  w.document.close();
};


// 背景顏色設定
D.bgColorInput.oninput = e => {
  document.body.style.backgroundColor = e.target.value;
  document.body.style.backgroundImage = 'none'; // 如果設置了顏色，清除圖片
};

// 背景圖片設定
D.bgImgInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    document.body.style.backgroundImage = `url(${ev.target.result})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundAttachment = 'fixed';
    document.body.style.backgroundPosition = 'center';
  };
  reader.readAsDataURL(file);
};

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  setAnalysisMode('dual'); // 確保頁面載入時是雙人模式
  // 為背景顏色輸入框設置預設值，使其顯示初始的 body 背景色
  D.bgColorInput.value = window.getComputedStyle(document.body).backgroundColor;
});

</script>
</body>
</html>
