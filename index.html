// 在 script 頂部定義
const els = {
  aBeast: $('#aBeast'),
  aKin: $('#aKin'),
  aBranch: $('#aBranch'),
  bBeast: $('#bBeast'),
  bKin: $('#bKin'),
  bBranch: $('#bBranch'),
  context: $('#context'),
  sexOptions: $('#sexOptions'),
  sexChecks: $$('.sex-check'),
  sexDetailInput: $('#sexDetailInput'),
  goButton: $('#go'),
  printButton: $('#print'),
  status: $('#status'),
  resultDiv: $('#result'), // 避免與方法名衝突
  chartDiv: $('#chart'),
  sexDeepDiv: $('#sexDeep'),
  sexDeepBody: $('#sexDeepBody'),
  chipMode: $('#chipMode'),
  chipA: $('#chipA'),
  chipB: $('#chipB'),
  chipBWrapper: $('#chipB_wrapper'),
  chipC: $('#chipC'),
  chipSexDetail: $('#chipSexDetail'),
  chipSexDetailWrapper: $('#chipSexDetail_wrapper'),
  presetButtons: $$('.preset')
};

// ... 然後在函數中使用緩存的元素

function determineMode() {
  const hasB = (els.bBeast.value && els.bKin.value && els.bBranch.value);
  const ctx = els.context.value.trim();
  return (!hasB || ctx === '個性分析') ? 'single' : 'dual';
}

// 情境 presets
els.presetButtons.forEach(b => b.onclick = () => {
  els.context.value = b.textContent.trim();
  toggleSexOptions();
  updateChips(getSelections());
});

// 性愛選項顯示
els.context.oninput = toggleSexOptions;
function toggleSexOptions() {
  const isSex = els.context.value.trim() === '性愛';
  els.sexOptions.classList.toggle('hidden', !isSex);
  if (!isSex) {
    els.sexChecks.forEach(c => c.checked = false);
    els.sexDetailInput.value = '';
    els.chipSexDetailWrapper.classList.add('hidden');
    els.sexDeepDiv.classList.add('hidden');
    els.sexDeepBody.innerHTML = '';
  }
}

function getSelections(){
  const mode = determineMode();
  return {
    mode,
    aBeast: els.aBeast.value, aKin: els.aKin.value, aBranch: els.aBranch.value,
    bBeast: els.bBeast.value, bKin: els.bKin.value, bBranch: els.bBranch.value,
    context: els.context.value.trim(),
    sexDetail: collectSexDetail() // 勾選＋文字摘要
  };
}

// ... 類似地更新其他函數
