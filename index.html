<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格｜一鍵分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* 基礎樣式 */
    .scores {display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 6px;}
    .score {display: flex; align-items: center; gap: 10px; font-size: 13px; color: #334155;}
    .bar {flex: 1; height: 10px; background: #e2e8f0; border-radius: 9999px; overflow: hidden;}
    .bar > i {display: block; height: 100%; background: #6366f1;}
    .score b {width: 92px; display: inline-block; color: #0f172a;}
    .score em {width: 36px; text-align: right; color: #475569; font-style: normal;}
    .tags {display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;}
    .tag {background: #eef2ff; color: #3730a3; padding: 4px 10px; border-radius: 9999px; font-size: 12px;}

    /* 列印樣式 */
    @media print {
      @page { margin: 14mm; }
      .no-print { display:none !important; }
      body { background:#fff !important; }
      .print-card { box-shadow:none !important; border:1px solid #e5e7eb; }
      .print-flex-container { display:flex; flex-wrap:wrap; gap:20px; margin-top:15px; align-items:flex-start; }
      .print-scores-section { flex:1; min-width:280px; max-width:45%; }
      .print-chart-section { flex:1; min-width:280px; max-width:50%; display:flex; justify-content:center; align-items:center; }
      .print-chart-section img { max-width:100%; height:auto; }
      .print-scores-section h3 { margin-top:0; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">仙人指路神獸七十二型人格｜一鍵分析</h1>
      <p class="text-slate-500 text-sm">選擇分析模式、對象與情境 → 按「一鍵分析」。支援分數條、雷達圖、列印 / 匯出 PDF。</p>
    </header>

    <!-- 模式切換 -->
    <div class="no-print">
      <div class="flex gap-4 mb-4">
        <button id="modePersonality" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">個性分析</button>
        <button id="modeSingle" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">單人分析</button>
        <button id="modeDual" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">雙人分析</button>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <!-- 我方 -->
        <section class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">我方 <span id="labelA" class="text-sm text-slate-500">(分析主體)</span></h2>
          <select id="aBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六獸</option>
            <option>青龍</option><option>朱雀</option><option>勾陳</option>
            <option>螣蛇</option><option>白虎</option><option>玄武</option>
          </select>
          <select id="aKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六親</option>
            <option>父母</option><option>兄弟</option><option>子孫</option>
            <option>妻財</option><option>官鬼</option>
          </select>
          <select id="aBranch" class="w-full border rounded-lg p-2">
            <option value="">地支</option>
            <option>子</option><option>丑</option><option>寅</option><option>卯</option>
            <option>辰</option><option>巳</option><option>午</option><option>未</option>
            <option>申</option><option>酉</option><option>戌</option><option>亥</option>
          </select>
        </section>

        <!-- 對方 -->
        <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">對方</h2>
          <select id="bBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六獸</option>
            <option>青龍</option><option>朱雀</option><option>勾陳</option>
            <option>螣蛇</option><option>白虎</option><option>玄武</option>
          </select>
          <select id="bKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六親</option>
            <option>父母</option><option>兄弟</option><option>子孫</option>
            <option>妻財</option><option>官鬼</option>
          </select>
          <select id="bBranch" class="w-full border rounded-lg p-2">
            <option value="">地支</option>
            <option>子</option><option>丑</option><option>寅</option><option>卯</option>
            <option>辰</option><option>巳</option><option>午</option><option>未</option>
            <option>申</option><option>酉</option><option>戌</option><option>亥</option>
          </select>
        </section>
      </div>
    </div>

    <!-- 情境 + 性愛深入 -->
    <section id="contextSection" class="bg-white p-4 rounded-2xl shadow-sm space-y-2 no-print">
      <h2 class="font-semibold">情境</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">年度目標協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">績效回饋會議</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">跨部門協作</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">壓期交付專案</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">人際關係協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">愛情</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">性愛</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="輸入情境…" />
      <div id="sexOptions" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
        <p class="font-semibold text-red-700 mb-2">性愛情境深入分析：</p>
        <div class="flex flex-wrap gap-2">
          <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="情境描述">情境描述</button>
          <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="姿勢建議">姿勢建議</button>
          <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="對話引導">對話引導</button>
          <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="感官探索">感官探索</button>
          <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="角色扮演">角色扮演</button>
          <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="深度連結">深度連結</button>
        </div>
        <textarea id="sexDetailInput" class="w-full mt-2 border rounded-lg p-2 text-sm" placeholder="輸入您想深入分析的細節，例如：『在海邊的夜晚』、『節奏偏快』、『挑逗的對話』…或點上方預設按鈕。"></textarea>
      </div>
    </section>

    <!-- 動作列 -->
    <div class="flex flex-wrap items-center gap-3 no-print">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">一鍵分析</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">列印 / 匯出 PDF</button>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- 結果 -->
    <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
      <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
        <span class="px-3 py-1 bg-slate-100 rounded-full">模式：<strong id="chipMode">—</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">我方：<strong id="chipA">—</strong></span>
        <span id="chipB_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">對方：<strong id="chipB">—</strong></span>
        <span id="chipC_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">情境：<strong id="chipC">—</strong></span>
        <span id="chipSexDetail_wrapper" class="px-3 py-1 bg-slate-100 rounded-full hidden">深入：<strong id="chipSexDetail">—</strong></span>
      </div>
      <div id="result" class="prose max-w-none text-[15px]"></div>
      <div id="chartContainer" class="mt-4"></div>
    </section>
  </div>

  <script>
    // 快捷選擇器
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // 狀態
    let analysisMode = 'dual';
    let radarChart = null;
    let lastScores = null; // 列印用

    // ====== 模擬資料（可用；接API後可移除） ======
    const dummyData = {
      result_qzl_qzz_sex: `
青龍子 X 青龍子 - 王者對決，燃燒慾望的極限較量

情愛指數：10/10（勢均力敵，無法預測的激情）

互動模式：當兩個青龍子相遇，性愛將是一場權力與征服的較量。雙方皆熱愛主導，充滿侵略性，彼此之間的關係就像一場永無止境的戰爭，誰能撐到最後才是贏家。

雷點分析：彼此爭奪主導權，容易陷入無休止的控制爭奪戰，若無法達成平衡，可能導致緊張關係。

最佳性愛劇本推薦：
- 強制互控挑戰：輪流爭奪主導權，以技巧與耐力分出勝負。
- 極限挑逗對決：延遲滿足與邊緣快感測試，拉高張力。
- 勝者支配：設定勝負條件，輸家需服從贏家要求。

推薦體位：站立交合、深度騎乘、交錯壓制
推薦道具：震動環、束縛繩、溫感潤滑液
推薦場景：鏡屋密室、高樓落地窗前、擂台/健身房

\`\`\`json
{
  "scores": { "fit": 95, "comm": 80, "pace": 90, "account": 70, "trust": 85, "innov": 98 },
  "tags": ["激情","主導","征服","競技","權力"]
}
\`\`\`
`,
      // 一般版（非性愛）— 你之前代碼有引用但沒有內容，這裡補齊
      result_qzl_qzz_general: `
青龍子 X 青龍子 - 同質相斥亦相生

• 優勢：
  - 決策快、推進力強。
  - 目標感一致，彼此理解彼此的野心與節奏。

• 風險：
  - 爭主導權，容易硬碰硬。
  - 兩人節奏都偏快，容易忽略風險控管。

• 建議：
  - 設輪值主導與衝突化解規則。
  - 用里程碑與數據裁決，減少情緒化爭執。

\`\`\`json
{
  "scores": { "fit": 88, "comm": 78, "pace": 95, "account": 72, "trust": 80, "innov": 90 },
  "tags": ["同質競合","快節奏","輪值主導","數據決策"]
}
\`\`\`
`,
      result_qzl_qzc_sex: `
青龍子 X 青龍丑 - 霸氣與沉穩的對峙

• 情愛指數：8.5/10（強勢與耐心的結合）
• 互動模式：一快一穩，若找到節奏可長期升溫。

\`\`\`json
{
  "scores": { "fit": 85, "comm": 70, "pace": 60, "account": 90, "trust": 80, "innov": 75 },
  "tags": ["霸氣","沉穩","耐心","拉扯","深層"]
}
\`\`\`
`,
      result_qzl_qzc_general: `
青龍子 X 青龍丑 - 潛力無限的互補組合

• 優勢：動靜互補、執行力強、能相互拉齊。
• 挑戰：節奏落差、溝通磨合、決策僵持。
• 建議：互相尊重、彈性調整、定期檢視。

\`\`\`json
{
  "scores": { "fit": 90, "comm": 85, "pace": 70, "account": 88, "trust": 92, "innov": 80 },
  "tags": ["互補","穩定","活力","協作","成長"]
}
\`\`\`
`,
      result_personality: `
青龍子個性分析 - 充滿活力與主導的開拓者

• 特質：積極主動、領導力強、創新思維、喜挑戰
• 潛在挑戰：過強勢、缺耐心、易衝動
• 建議：學協作、養耐性、先評估風險

\`\`\`json
{
  "scores": { "fit": null, "comm": 80, "pace": 95, "account": 90, "trust": 75, "innov": 90 },
  "tags": ["主動","領導","創新","自信","高效"]
}
\`\`\`
`,
      result_default: `
請選擇有效的六獸、六親、地支組合及情境進行分析。

\`\`\`json
{
  "scores": { "fit": 50, "comm": 50, "pace": 50, "account": 50, "trust": 50, "innov": 50 },
  "tags": ["通用分析"]
}
\`\`\`
`
    };

    // 產生分數條
    function generateScoresHTML(scores) {
      if (!scores || Object.values(scores).every(v => v === null || isNaN(v))) return '';
      const scoreData = {
        fit: scores.fit ?? scores['契合'] ?? 0,
        comm: scores.comm ?? scores['溝通'] ?? 0,
        pace: scores.pace ?? scores['節奏'] ?? 0,
        account: scores.account ?? scores['權責'] ?? 0,
        trust: scores.trust ?? scores['信任'] ?? 0,
        innov: scores.innov ?? scores['創新'] ?? 0,
      };
      const clamp = v => Math.max(0, Math.min(100, Number(v) || 0));
      const row = (label, key, color) =>
        `<div class="score"><b>${label}</b><div class="bar"><i style="width:${clamp(scoreData[key])}%;background:${color}"></i></div><em>${clamp(scoreData[key])}</em></div>`;
      return `
        <h3 class="text-lg font-semibold mt-4">六維度分數</h3>
        <div class="scores">
          ${row('契合 fit','fit','#22c55e')}
          ${row('溝通 comm','comm','#06b6d4')}
          ${row('節奏 pace','pace','#f59e0b')}
          ${row('權責 account','account','#8b5cf6')}
          ${row('信任 trust','trust','#ef4444')}
          ${row('創新 innov','innov','#6366f1')}
        </div>`;
    }

    // 模式切換
    function setAnalysisMode(mode) {
      analysisMode = mode;
      $$('#modePersonality, #modeSingle, #modeDual').forEach(btn => {
        btn.classList.replace('bg-indigo-600','bg-slate-200');
        btn.classList.replace('text-white','text-slate-800');
      });
      $(`#mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.replace('bg-slate-200','bg-indigo-600');
      $(`#mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.replace('text-slate-800','text-white');

      if (mode === 'personality') {
        $('#sectionB').style.display = 'none';
        $('#contextSection').style.display = 'none';
        $('#labelA').textContent = '(分析對象)';
        $('#bBeast').value = ''; $('#bKin').value = ''; $('#bBranch').value = '';
        $('#chipB_wrapper').style.display = 'none';
        $('#context').value = '';
        $('#chipC_wrapper').style.display = 'none';
        toggleSexOptions();
      } else if (mode === 'single') {
        $('#sectionB').style.display = 'none';
        $('#contextSection').style.display = 'block';
        $('#labelA').textContent = '(分析主體)';
        $('#bBeast').value = ''; $('#bKin').value = ''; $('#bBranch').value = '';
        $('#chipB_wrapper').style.display = 'none';
        $('#chipC_wrapper').style.display = 'block';
      } else {
        $('#sectionB').style.display = 'block';
        $('#contextSection').style.display = 'block';
        $('#labelA').textContent = '';
        $('#chipB_wrapper').style.display = 'block';
        $('#chipC_wrapper').style.display = 'block';
      }
      updateChips(getSelections());
    }

    // 情境 preset 與性愛深入選項
    $$('.preset').forEach(b => b.onclick = () => {
      $('#context').value = b.textContent;
      toggleSexOptions();
      updateChips(getSelections());
    });
    $('#context').oninput = () => { toggleSexOptions(); updateChips(getSelections()); };
    $$('.sex-detail').forEach(b => b.onclick = () => {
      const current = $('#sexDetailInput').value.trim();
      const t = b.dataset.detail;
      if (!current.includes(t)) $('#sexDetailInput').value = (current ? current + '；' : '') + t;
      updateChips(getSelections());
    });
    $('#sexDetailInput').oninput = () => updateChips(getSelections());

    function toggleSexOptions(){
      if ($('#context').value.trim() === '性愛') {
        $('#sexOptions').classList.remove('hidden');
      } else {
        $('#sexOptions').classList.add('hidden');
        $('#sexDetailInput').value = '';
      }
    }

    // 讀取目前選擇
    function getSelections(){
      return {
        mode: analysisMode,
        aBeast: $('#aBeast').value, aKin: $('#aKin').value, aBranch: $('#aBranch').value,
        bBeast: $('#bBeast').value, bKin: $('#bKin').value, bBranch: $('#bBranch').value,
        context: analysisMode === 'personality' ? '' : $('#context').value.trim(),
        sexDetail: ($('#context').value.trim() === '性愛' && !$('#sexOptions').classList.contains('hidden'))
          ? $('#sexDetailInput').value.trim() : ''
      };
    }

    // 晶片顯示
    function updateChips({mode,aBeast,aKin,aBranch,bBeast,bKin,bBranch,context,sexDetail}){
      $('#chipMode').textContent = ({ personality:'個性分析', single:'單人分析', dual:'雙人分析' })[mode];
      $('#chipA').textContent = [aBeast,aKin,aBranch].filter(Boolean).join(' × ') || '—';
      if (mode==='dual') { $('#chipB').textContent = [bBeast,bKin,bBranch].filter(Boolean).join(' × ') || '—'; $('#chipB_wrapper').style.display='block'; }
      else { $('#chipB_wrapper').style.display='none'; }
      if (mode!=='personality') { $('#chipC').textContent = context || '—'; $('#chipC_wrapper').style.display='block'; }
      else { $('#chipC_wrapper').style.display='none'; }
      if (context==='性愛' && sexDetail) { $('#chipSexDetail').textContent = sexDetail; $('#chipSexDetail_wrapper').classList.remove('hidden'); }
      else { $('#chipSexDetail_wrapper').classList.add('hidden'); }
    }

    // 文字+JSON → HTML 與 scores
    function formatOutputWithJson(text){
      if(!text) return { html:'', scores:null, tagsHTML:'' };

      const jsonBlock = text.match(/```json([\s\S]*?)```/i);
      let json = null;
      if(jsonBlock){
        try{ json = JSON.parse(jsonBlock[1]); }catch(_){}
        text = text.replace(jsonBlock[0], '').trim();
      }

      let scores = null;
      if (json && json.scores) {
        scores = json.scores;
      } else {
        const map = { fit:null, comm:null, pace:null, account:null, trust:null, innov:null };
        const rx = /(?:契合|fit)\s*[:：]?\s*(\d{1,3})|(?:溝通|comm)\s*[:：]?\s*(\d{1,3})|(?:節奏|pace)\s*[:：]?\s*(\d{1,3})|(?:權責|account)\s*[:：]?\s*(\d{1,3})|(?:信任|trust)\s*[:：]?\s*(\d{1,3})|(?:創新|innov)\s*[:：]?\s*(\d{1,3})/ig;
        let m;
        while((m = rx.exec(text))){
          if (m[1]) map.fit = Number(m[1]);
          if (m[2]) map.comm = Number(m[2]);
          if (m[3]) map.pace = Number(m[3]);
          if (m[4]) map.account = Number(m[4]);
          if (m[5]) map.trust = Number(m[5]);
          if (m[6]) map.innov = Number(m[6]);
        }
        const filled = Object.values(map).filter(v => typeof v==='number' && !isNaN(v));
        if (filled.length>=2) scores = map;
      }

      let html = text
        .replace(/\n\s*\n/g, '\n')
        .replace(/^\s*(?:[\d]+\)|[•\-–])\s*(.+)$/gm, '<h3 class="text-lg font-semibold mt-4">$1</h3>')
        .replace(/^\s*[-•–]\s*(.+)$/gm, '<li>$1</li>');
      html = html.replace(/(?:<li>[^<]*<\/li>\n?)+/g, m => `<ul class="list-disc pl-5 space-y-1">${m}</ul>`);
      html = html.replace(/\n/g,'<br>');

      const tagsHTML = (json && Array.isArray(json.tags) && json.tags.length)
        ? `<div class="tags">${json.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>` : '';

      return { html, scores, tagsHTML };
    }

    // 雷達圖渲染
    function renderRadar(scores){
      const chartContainer = $('#chartContainer');
      chartContainer.innerHTML = '';
      lastScores = scores || null;

      const hasValidScores = scores && Object.values(scores).some(v => v !== null && !isNaN(v));
      if (!hasValidScores) {
        chartContainer.innerHTML = generateScoresHTML(scores);
        if(radarChart){ radarChart.destroy(); radarChart=null; }
        return;
      }

      const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
      const labels = ['契合 fit','溝通 comm','節奏 pace','權責 account','信任 trust','創新 innov'];
      const data = [clamp(scores.fit),clamp(scores.comm),clamp(scores.pace),clamp(scores.account),clamp(scores.trust),clamp(scores.innov)];

      chartContainer.innerHTML = `
        <div class="md:flex md:gap-8 md:items-start">
          <div class="flex-1">${generateScoresHTML(scores)}</div>
          <div class="flex-1 w-full h-64 md:h-80"><canvas id="radar"></canvas></div>
        </div>`;

      const canvas = $('#radar');
      if(radarChart) radarChart.destroy();
      radarChart = new Chart(canvas.getContext('2d'), {
        type: 'radar',
        data: { labels, datasets: [{ label: '六維度雷達圖', data, fill: true, backgroundColor: 'rgba(99,102,241,0.15)', borderColor: 'rgba(99,102,241,1)', pointBackgroundColor: 'rgba(99,102,241,1)'}] },
        options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } } }, plugins: { legend: { display: false } } }
      });
    }

    // 一鍵分析（單一版本）
    async function performAnalysis() {
      const payload = getSelections();
      updateChips(payload);

      let isValid = false;
      if (payload.mode === 'personality') {
        isValid = (payload.aBeast && payload.aKin && payload.aBranch);
        if (!isValid) { alert('個性分析：請先選滿我方「六獸、六親、地支」'); return; }
      } else if (payload.mode === 'single') {
        isValid = (payload.aBeast && payload.aKin && payload.aBranch && payload.context);
        if (!isValid) { alert('單人分析：請先選滿我方「六獸、六親、地支」與情境'); return; }
      } else {
        isValid = (payload.aBeast && payload.aKin && payload.aBranch && payload.bBeast && payload.bKin && payload.bBranch && payload.context);
        if (!isValid) { alert('雙人分析：請先選滿我方/對方「六獸、六親、地支」與情境'); return; }
      }

      $('#status').textContent = '分析中…';
      $('#result').innerHTML = '';
      $('#chartContainer').innerHTML = '';

      try {
        // =============================
        // TODO：接你的後端 API
        // const res = await fetch('/api/analyze', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(payload)
        // });
        // const data = await res.json();
        // const plain = data.resultText; // 後端回傳的純文字 + ```json 區塊
        // =============================

        // 先用內建 dummy 資料保證可操作
        let plain = dummyData.result_default;
        if (payload.mode === 'personality') {
          if (payload.aBeast==='青龍' && payload.aBranch==='子') plain = dummyData.result_personality;
        } else if (payload.mode === 'single') {
          if (payload.aBeast==='青龍' && payload.aBranch==='子' && payload.context==='年度目標協調') {
            plain = `
青龍子在「年度目標協調」情境下的分析

• 特點：強勢主導、追求創新、高效推進
• 潛在挑戰：忽略意見、目標過激進、溝通不足
• 建議：開放式溝通、分解目標、權衡風險

\`\`\`json
{
  "scores": { "fit": null, "comm": 70, "pace": 90, "account": 85, "trust": 75, "innov": 90 },
  "tags": ["主導","創新","高效","溝通","協調"]
}
\`\`\`
`;
          }
        } else { // dual
          if (payload.aBeast==='青龍' && payload.aBranch==='子' && payload.bBeast==='青龍' && payload.bBranch==='子') {
            plain = (payload.context==='性愛') ? dummyData.result_qzl_qzz_sex : dummyData.result_qzl_qzz_general;
          } else if (payload.aBeast==='青龍' && payload.aBranch==='子' && payload.bBeast==='青龍' && payload.bBranch==='丑') {
            plain = (payload.context==='性愛') ? dummyData.result_qzl_qzc_sex : dummyData.result_qzl_qzc_general;
          }
        }

        const formatted = formatOutputWithJson(plain);
        $('#result').innerHTML = formatted.html + (formatted.tagsHTML || '');
        renderRadar(formatted.scores);
        $('#status').textContent = '✅ 完成';
      } catch (e) {
        $('#status').textContent = '❌ 失敗';
        $('#result').textContent = String(e);
        console.error('Analysis failed:', e);
      }
    }

    // 列印 / 匯出 PDF（含雷達圖快照）
    $('#print').onclick = () => {
      const sel = getSelections(); updateChips(sel);
      let chartImg = '';
      const ok = radarChart && radarChart.data && radarChart.data.datasets?.[0]?.data?.some(v => v !== null && !isNaN(v));
      if (ok && radarChart.canvas) {
        try {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = radarChart.canvas.width;
          tempCanvas.height = radarChart.canvas.height;
          const ctx = tempCanvas.getContext('2d');
          ctx.fillStyle = 'white';
          ctx.fillRect(0,0,tempCanvas.width,tempCanvas.height);
          ctx.drawImage(radarChart.canvas,0,0);
          chartImg = `<div class="print-chart-section"><img src="${tempCanvas.toDataURL('image/png')}" style="max-width:100%;height:auto" alt="雷達圖"></div>`;
        } catch (e) { console.error('無法生成雷達圖圖片:', e); }
      }

      const originalBody = document.body.innerHTML;
      const originalBodyClass = document.body.className;

      const printContent = `
        <div class="max-w-5xl mx-auto p-6 space-y-5">
          <header>
            <h1 class="text-2xl font-bold">仙人指路神獸七十二型人格｜分析報告</h1>
            <p class="text-slate-500 text-sm">${new Date().toLocaleString()}</p>
          </header>
          <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
            <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
              <span class="px-3 py-1 bg-slate-100 rounded-full">模式：<strong>${$('#chipMode').textContent}</strong></span>
              <span class="px-3 py-1 bg-slate-100 rounded-full">我方：<strong>${$('#chipA').textContent}</strong></span>
              ${sel.mode==='dual' ? `<span class="px-3 py-1 bg-slate-100 rounded-full">對方：<strong>${$('#chipB').textContent}</strong></span>` : ''}
              ${sel.mode!=='personality' ? `<span class="px-3 py-1 bg-slate-100 rounded-full">情境：<strong>${$('#chipC').textContent}</strong></span>` : ''}
              ${(sel.context==='性愛' && sel.sexDetail) ? `<span class="px-3 py-1 bg-slate-100 rounded-full">深入：<strong>${$('#chipSexDetail').textContent}</strong></span>` : ''}
            </div>
            <div class="prose max-w-none text-[15px]">
              ${$('#result').innerHTML}
            </div>
            <div class="print-flex-container">
              <div class="print-scores-section">
                ${generateScoresHTML(lastScores)}
              </div>
              ${chartImg}
            </div>
          </section>
        </div>
      `;

      document.body.innerHTML = printContent;
      document.body.classList.remove('bg-slate-50','text-slate-800');
      document.body.classList.add('bg-white','text-black');
      window.print();
      document.body.innerHTML = originalBody;
      document.body.className = originalBodyClass;

      attachEventListeners();
      setAnalysisMode(analysisMode);
      updateChips(getSelections());
      const currentResultText = $('#result').innerHTML;
      const formattedAfterPrint = formatOutputWithJson(currentResultText);
      renderRadar(formattedAfterPrint.scores);
    };

    // 綁定事件
    function attachEventListeners(){
      $('#modePersonality').onclick = () => setAnalysisMode('personality');
      $('#modeSingle').onclick = () => setAnalysisMode('single');
      $('#modeDual').onclick = () => setAnalysisMode('dual');

      $$('.preset').forEach(b => b.onclick = () => {
        $('#context').value = b.textContent;
        toggleSexOptions();
        updateChips(getSelections());
      });

      $('#context').oninput = () => { toggleSexOptions(); updateChips(getSelections()); };

      $$('.sex-detail').forEach(b => b.onclick = () => {
        const t = b.dataset.detail;
        const cur = $('#sexDetailInput').value.trim();
        if (!cur.includes(t)) $('#sexDetailInput').value = (cur ? cur + '；' : '') + t;
        updateChips(getSelections());
      });

      $('#sexDetailInput').oninput = () => updateChips(getSelections());

      $('#go').onclick = performAnalysis;

      $$('select').forEach(sel => { sel.onchange = () => updateChips(getSelections()); });
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      setAnalysisMode('dual');
      attachEventListeners();
      updateChips(getSelections());
    });

    // 顯示未捕捉錯誤到狀態列，方便除錯
    window.addEventListener('error', (e)=>{
      console.error(e.error || e.message);
      const s = $('#status');
      if (s) s.textContent = '⚠️ 腳本錯誤：' + (e.error?.message || e.message || 'unknown');
    });
  </script>
</body>
</html>
