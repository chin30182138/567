<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格 一鍵分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    @media print { @page { margin: 14mm; } .no-print { display:none !important; } body { background:#fff !important; } .print-card { box-shadow:none !important; border:1px solid #e5e7eb; } }
    .scores{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
    .score{display:flex;align-items:center;gap:10px;font-size:13px;color:#334155}
    .bar{flex:1;height:10px;background:#e2e8f0;border-radius:9999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:#6366f1}
    .score b{width:92px;display:inline-block;color:#0f172a}
    .score em{width:36px;text-align:right;color:#475569;font-style:normal}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:9999px;font-size:12px}
    .pill{display:inline-block;background:#f1f5f9;padding:4px 10px;border-radius:9999px;font-size:13px;margin:2px 4px 2px 0}
    .section-title{margin-top:12px;font-weight:600;color:#334155}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">仙人指路神獸七十二型人格｜一鍵分析</h1>
      <p class="text-slate-500 text-sm">選擇分析對象、情境 → 按「一鍵分析」。支援分數條、雷達圖、列印 / 匯出 PDF。</p>
    </header>

    <!-- 我方/對方 選單 -->
    <div class="no-print">
      <div class="flex gap-4 mb-4">
        <button id="modeSingle" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">單人分析</button>
        <button id="modeDual" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">雙人分析</button>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <!-- 我方 -->
        <section class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">我方 <span id="labelA" class="text-sm text-slate-500">(分析主體)</span></h2>
          <select id="aBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六獸</option>
            <option>青龍</option><option>朱雀</option><option>勾陳</option>
            <option>螣蛇</option><option>白虎</option><option>玄武</option>
          </select>
          <select id="aKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六親</option>
            <option>父母</option><option>兄弟</option><option>子孫</option>
            <option>妻財</option><option>官鬼</option>
          </select>
          <select id="aBranch" class="w-full border rounded-lg p-2">
            <option value="">地支</option>
            <option>子</option><option>丑</option><option>寅</option><option>卯</option>
            <option>辰</option><option>巳</option><option>午</option><option>未</option>
            <option>申</option><option>酉</option><option>戌</option><option>亥</option>
          </select>
        </section>

        <!-- 對方 -->
        <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">對方</h2>
          <select id="bBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六獸</option>
            <option>青龍</option><option>朱雀</option><option>勾陳</option>
            <option>螣蛇</option><option>白虎</option><option>玄武</option>
          </select>
          <select id="bKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">六親</option>
            <option>父母</option><option>兄弟</option><option>子孫</option>
            <option>妻財</option><option>官鬼</option>
          </select>
          <select id="bBranch" class="w-full border rounded-lg p-2">
            <option value="">地支</option>
            <option>子</option><option>丑</option><option>寅</option><option>卯</option>
            <option>辰</option><option>巳</option><option>午</option><option>未</option>
            <option>申</option><option>酉</option><option>戌</option><option>亥</option>
          </select>
        </section>
      </div>
    </div>

    <!-- 情境 -->
    <section class="bg-white p-4 rounded-2xl shadow-sm space-y-2 no-print">
      <h2 class="font-semibold">情境</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">年度目標協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">績效回饋會議</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">跨部門協作</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">壓期交付專案</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">人際關係協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">愛情</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">性愛</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="輸入情境…" />
    </section>

    <!-- 動作列 -->
    <div class="flex flex-wrap items-center gap-3 no-print">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">一鍵分析</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">列印 / 匯出 PDF</button>
      <button id="genTpl" class="px-4 py-2 rounded-xl bg-red-500 text-white">用 AI 產生此組合模板</button>
      <button id="saveTpl" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">下載目前模板 JSON</button>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- 結果區 -->
    <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
      <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
        <span class="px-3 py-1 bg-slate-100 rounded-full">模式：<strong id="chipMode">—</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">我方：<strong id="chipA">—</strong></span>
        <span id="chipB_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">對方：<strong id="chipB">—</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">情境：<strong id="chipC">—</strong></span>
      </div>
      <div id="result" class="prose max-w-none text-[15px]"></div>
      <div id="chart" class="mt-4"></div>
      <div id="sexDeep" class="mt-6 hidden">
        <h3 class="text-lg font-semibold">AI 模板產生結果</h3>
        <div id="sexDeepBody" class="mt-2 text-[15px]"></div>
      </div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let analysisMode = 'dual';

    function getSelections(){
      return {
        mode: analysisMode,
        aBeast: $('#aBeast').value, aKin: $('#aKin').value, aBranch: $('#aBranch').value,
        bBeast: $('#bBeast').value, bKin: $('#bKin').value, bBranch: $('#bBranch').value,
        context: $('#context').value.trim()
      };
    }

    function updateChips({mode, aBeast,aKin,aBranch,bBeast,bKin,bBranch,context}){
      $('#chipMode').textContent = mode === 'single' ? '單人' : '雙人';
      $('#chipA').textContent = [aBeast,aKin,aBranch].filter(Boolean).join(' × ') || '—';
      if (mode === 'dual') {
        $('#chipB').textContent = [bBeast,bKin,bBranch].filter(Boolean).join(' × ') || '—';
        $('#chipB_wrapper').style.display = 'block';
      } else {
        $('#chipB_wrapper').style.display = 'none';
      }
      $('#chipC').textContent = context || '—';
    }

    // === AI 產生此組合模板 ===
    $('#genTpl').onclick = async () => {
      const sel = getSelections();
      updateChips(sel);
      $('#status').textContent = 'AI 產生模板中…';

      try {
        const res = await fetch('/api/sex-template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sel),
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || 'Unknown error');
        }

        const data = await res.json();
        let plain = data.text || data.result;
        if (!plain && Array.isArray(data.output)) {
          plain = data.output.map(o => (o.content||[]).map(c=>c.text||'').join('\n')).join('\n');
        }
        if (!plain) plain = JSON.stringify(data, null, 2);

        const safeTplHtml = DOMPurify.sanitize(plain, {
          ALLOWED_TAGS: ['h3','h4','p','ul','ol','li','div','span','b','strong','em','br'],
          ALLOWED_ATTR: []
        });
        $('#sexDeepBody').innerHTML = safeTplHtml;
        $('#sexDeep').classList.remove('hidden');

        $('#status').textContent = '✅ 模板完成';
      } catch (e) {
        console.error(e);
        $('#status').textContent = '❌ 模板產生失敗';
        alert('產生失敗：' + (e.message || e));
      }
    };
  </script>
</body>
</html>
