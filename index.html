<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格 一鍵分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    @media print {
      @page { margin: 14mm; }
      .no-print { display:none !important; }
      body { background:#fff !important; }
      .print-card { box-shadow:none !important; border:1px solid #e5e7eb; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-3xl mx-auto p-4 md:p-6 space-y-6">
    <header class="no-print">
      <h1 class="text-2xl font-bold">仙人指路｜神獸七十二型人格 一鍵分析</h1>
      <p class="text-sm text-gray-600">（整合版介面｜含性愛深度分析卡）</p>
    </header>

    <!-- ===== 控制列 ===== -->
    <section class="no-print grid grid-cols-1 md:grid-cols-3 gap-3">
      <button id="btnAnalyze" class="px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">一鍵分析</button>
      <button id="btnPrint" class="px-4 py-3 rounded-lg bg-gray-800 text-white font-semibold hover:bg-black">列印 / 匯出 PDF</button>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">狀態：</span>
        <span id="status" class="text-sm font-semibold text-gray-800">待命</span>
      </div>
    </section>

    <!-- ===== 參數設定 ===== -->
    <section class="bg-white rounded-xl shadow print-card">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-center gap-3">
          <label class="font-semibold">模式：</label>
          <select id="mode" class="border rounded px-3 py-2">
            <option value="single">單人</option>
            <option value="double" selected>雙人</option>
          </select>

          <label class="font-semibold">情境：</label>
          <select id="scene" class="border rounded px-3 py-2">
            <option value="general">一般</option>
            <option value="sex" selected>性愛</option>
            <option value="relationship">關係/溝通</option>
            <option value="team">職場/合作</option>
          </select>

          <label class="inline-flex items-center gap-2 ml-auto">
            <input id="ckPace" type="checkbox" class="w-4 h-4">
            <span class="text-sm">節奏變化</span>
          </label>
        </div>
      </div>

      <!-- 我方 -->
      <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-3 border-b">
        <div class="md:col-span-3 font-semibold text-indigo-700">我方設定</div>
        <div>
          <label class="text-sm block mb-1">六獸</label>
          <select id="aBeast" class="w-full border rounded px-3 py-2">
            <option>青龍</option><option selected>朱雀</option><option>勾陳</option><option>螣蛇</option><option>白虎</option><option>玄武</option>
          </select>
        </div>
        <div>
          <label class="text-sm block mb-1">六親</label>
          <select id="aKin" class="w-full border rounded px-3 py-2">
            <option>父母</option><option selected>兄弟</option><option>子孫</option><option>妻財</option><option>官鬼</option>
          </select>
        </div>
        <div>
          <label class="text-sm block mb-1">地支</label>
          <select id="aBranch" class="w-full border rounded px-3 py-2">
            <option>子</option><option>丑</option><option>寅</option><option>卯</option><option>辰</option><option>巳</option>
            <option>午</option><option selected>未</option><option>申</option><option>酉</option><option>戌</option><option>亥</option>
          </select>
        </div>
      </div>

      <!-- 對方（雙人時可見） -->
      <div id="bPanel" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-3 border-b">
        <div class="md:col-span-3 font-semibold text-rose-700">對方設定</div>
        <div>
          <label class="text-sm block mb-1">六獸</label>
          <select id="bBeast" class="w-full border rounded px-3 py-2">
            <option>青龍</option><option>朱雀</option><option>勾陳</option><option>螣蛇</option><option>白虎</option><option selected>玄武</option>
          </select>
        </div>
        <div>
          <label class="text-sm block mb-1">六親</label>
          <select id="bKin" class="w-full border rounded px-3 py-2">
            <option>父母</option><option>兄弟</option><option>子孫</option><option>妻財</option><option selected>官鬼</option>
          </select>
        </div>
        <div>
          <label class="text-sm block mb-1">地支</label>
          <select id="bBranch" class="w-full border rounded px-3 py-2">
            <option>子</option><option>丑</option><option>寅</option><option>卯</option><option>辰</option><option>巳</option>
            <option>午</option><option>未</option><option>申</option><option selected>酉</option><option>戌</option><option>亥</option>
          </select>
        </div>
      </div>

      <!-- 其他補充 -->
      <div class="p-4 space-y-2">
        <label class="block text-sm">補充你想納入的情境或界線（例：音樂燈光、可接受/不可接受、溝通方式…）</label>
        <textarea id="context" rows="3" class="w-full border rounded px-3 py-2" placeholder="可空白"></textarea>
      </div>
    </section>

    <!-- ===== 結果區 ===== -->
    <section id="result" class="bg-white rounded-xl shadow p-4 print-card space-y-4">
      <div id="summary" class="text-sm text-gray-700"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 雷達圖 -->
        <div class="p-4 border rounded-lg">
          <h3 class="font-semibold mb-3">互動雷達圖</h3>
          <canvas id="radar" height="260"></canvas>
        </div>

        <!-- 深度分析卡 -->
        <div id="deepCard" class="p-4 border rounded-lg bg-pink-50"></div>
      </div>
    </section>

    <footer class="no-print text-center text-xs text-gray-500 pb-10">
      © 仙人指路｜介面整合版
    </footer>
  </div>

  <script>
    // ------- 小工具 -------
    function hashTo01(str) {
      let h = 2166136261 >>> 0; // FNV-1a
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0) / 0xffffffff; // 0~1
    }
    function scoreByKey(key, bias = 0.5, spread = 0.35, min=25, max=90) {
      const v = bias + (hashTo01(key) - 0.5) * 2 * spread; // 約 0~1
      const clamped = Math.max(0, Math.min(1, v));
      return Math.round(min + clamped * (max - min));
    }
    const labelMap = { comm:'溝通', pace:'節奏', account:'權責', trust:'信任', innov:'創新', fit:'契合' };
    function escapeHTML(s){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
    function applyBias(val, bias=0) {
      const v = val + Math.round(bias*100)/1; // bias 是 -1~1 的小量
      return Math.max(10, Math.min(95, v));
    }

    // ------- 雷達圖 -------
    const radarCtx = document.getElementById('radar').getContext('2d');
    let radarChart = new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ['溝通','節奏','權責','信任','創新','契合'],
        datasets: [{ label:'互動分佈', data:[50,50,50,50,50,50], fill:true }]
      },
      options: {
        responsive: true,
        scales: { r: { min:0, max:100, ticks:{ stepSize:20 } } },
        plugins: { legend: { display:false } }
      }
    });

    // ------- 六獸偏置（讓分數更像話） -------
    const beastBias = {
      "青龍": {comm:+0.06, innov:+0.05},
      "朱雀": {comm:+0.10, trust:-0.02},
      "勾陳": {account:+0.08, pace:-0.03},
      "螣蛇": {innov:+0.08, trust:-0.03},
      "白虎": {account:+0.10, comm:-0.04},
      "玄武": {trust:+0.08, innov:-0.03}
    };

    // ====== 語感模板庫（六獸 × 六親 × 地支）======
    const SEX_BEAST_TONE = {
      "青龍": { vibe: "靈活主動、擅長逗引與變速", lead: "以節奏與花樣主導", kink: "遊戲規則、角色扮演" },
      "朱雀": { vibe: "語言挑逗、火熱外放", lead: "靠聲音與眼神牽引", kink: "言語命令、舞台感" },
      "勾陳": { vibe: "穩健鋪陳、重儀式感與安全", lead: "以流程與步驟掌控", kink: "前戲儀式、慢慢累積" },
      "螣蛇": { vibe: "神秘勾魂、張弛交替", lead: "以忽近忽遠吊足胃口", kink: "遮眼與感官轉換" },
      "白虎": { vibe: "直接果決、控制欲強", lead: "以力度與關鍵節點掌控", kink: "主導/臣服邊界遊戲" },
      "玄武": { vibe: "安靜深沉、重包覆與信任", lead: "以穩定能量收攏節奏", kink: "長時擁抱、深呼吸同步" }
    };

    const SEX_KIN_DYNAMICS = {
      "父母":  "傾向照顧與引導，容易把節奏當『教學』；需留意別過度糾正。",
      "兄弟":  "互不服輸、較量意味濃厚；競賽式挑逗能迅速升溫。",
      "子孫":  "玩心重、求新求變；用遊戲規則與任務卡最好使。",
      "妻財":  "交換與回饋明確；『你給我什麼、我回你什麼』很管用。",
      "官鬼":  "權力張力強，主從角色最容易啟動；需先談好界線。"
    };

    const BRANCH_FLAVOR = {
      "子": "偏水：冷熱落差敏感，喜暗光與耳語。",
      "丑": "偏土：需要場地與靠墊支撐，穩定後才放開。",
      "寅": "偏木：開場快、越玩越上手；喜路線規畫。",
      "卯": "偏木：重氛圍與美感，節奏要順暢無卡點。",
      "辰": "土混：容易想太多；先定規則再上場會更自在。",
      "巳": "偏火：升溫快、爆發力強；要設安全詞。",
      "午": "純火：舞台感最強，燈光與音樂一上就進狀態。",
      "未": "偏土：慢熱但續航好；喜長時間鋪陳與收束。",
      "申": "金水交：對細節敏感，喜精準節拍與巧妙停頓。",
      "酉": "偏金：儀容與道具要到位；偏好乾淨俐落的轉場。",
      "戌": "燥土：需要被說服與認可；先談期待再點火。",
      "亥": "純水：情緒流很重要；以擁抱與貼近帶入最穩。"
    };

    // ====== 升級版：性愛深度分析卡 ======
    function buildSexDeepCard(model) {
      const {
        mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch,
        scene, paceOn, contextText, scores
      } = model;

      // 指標運算
      const loveIdx = Math.round((scores.fit * 0.6) + (scores.trust * 0.4));
      const spice   = Math.round((scores.innov * 0.5) + (scores.pace * 0.3) + (scores.comm * 0.2));
      const control = Math.round((scores.account * 0.5) + (scores.comm * 0.3) + (scores.trust * 0.2));

      // 六獸語感
      const A = SEX_BEAST_TONE[aBeast] || { vibe:"中性", lead:"彼此協作", kink:"溫和互動" };
      const B = SEX_BEAST_TONE[bBeast] || A;

      // 六親/地支風味
      const kinA = SEX_KIN_DYNAMICS[aKin] || "";
      const kinB = SEX_KIN_DYNAMICS[bKin] || "";
      const brA  = BRANCH_FLAVOR[aBranch] || "";
      const brB  = BRANCH_FLAVOR[bBranch] || "";

      // 三幕劇腳本
      const openLine = (who, beast, branch) => {
        const tone = SEX_BEAST_TONE[beast]?.vibe || "中性";
        const br   = (BRANCH_FLAVOR[branch] || "").replace(/^偏.|純./,'') || "氛圍";
        return `${who}以${tone}開場，場域先鋪上「${br}」的味道，彼此呼吸逐步對齊。`;
      };
      const midLine = () => {
        if (spice >= 75) {
          return "主段節奏改用『兩快一慢』與「停頓凝視」交替，語言與肢體同時上線，熱度層層疊高。";
        } else if (spice >= 60) {
          return "主段採『遞增式』推進：每三個循環增加一點力度或密度，維持對話可中途微調。";
        } else {
          return "主段以『長呼吸＋長逗留』為主，避免一次加太多變化，確保身心都跟得上。";
        }
      };
      const closeLine = () => {
        if (control >= 70) {
          return "收束以『回到擁抱→口頭回饋→下次想嘗試一件新元素』結尾，讓安全與信任鎖定。";
        } else {
          return "收束改為『安靜相貼 2 分鐘→喝水→簡短交流 3 句』，避免過度檢討打壞餘韻。";
        }
      };

      // 角色傾向
      const roleA = A.lead;
      const roleB = B.lead;
      const kinkA = A.kink;
      const kinkB = B.kink;

      // 任務卡
      const tasks = [];
      if (scores.comm < 60) tasks.push("設定安全詞（綠/黃/紅）與『停手手勢』，任何時刻可啟動。");
      if (scores.pace < 60) tasks.push("用『3 段式節奏』：暖身 4 分鐘 → 高峰 6 分鐘 → 收束 3 分鐘。");
      if (scores.trust < 60) tasks.push("先做非性向親密：互相按摩肩頸 3 分鐘，建立身體信任。");
      if (scores.account < 60) tasks.push("事前說明『可以/不可以/暫不確定』清單，各列 3 點。");
      if (scores.innov < 60) tasks.push("採『一新一熟』原則：這次只加入 1 個新元素（例如：遮眼/語音指令/音樂節拍）。");
      if (!tasks.length) tasks.push("維持當前配方，微調 1 個元素即可（如：音量、光線或節拍）。");

      // 風險
      const risks = [];
      if (mode === 'double' && (aKin === '官鬼' || bKin === '官鬼')) risks.push("權力張力強：務必先說好邊界與撤退條件。");
      if (aBeast === '白虎' || bBeast === '白虎') risks.push("主導傾向高：注意對方回饋，不要一路加壓。");
      if (aBeast === '朱雀' || bBeast === '朱雀') risks.push("語言強度高：避免羞辱與貼標籤，改用描述式語言。");
      if (scores.pace <= 45) risks.push("節奏過急：容易失去身體回應；請把『停頓＋呼吸』放進每個循環。");
      if (!risks.length) risks.push("整體風險低：照既定節奏前進即可。");

      const title = scene === 'sex' ? '性愛深度分析' :
                    scene === 'relationship' ? '關係深度分析' : '互動深度分析';

      // 組裝輸出
      const div = document.createElement('div');
      div.className = "space-y-4";

      const pairText = mode === 'single'
        ? `我方：${aBeast} × ${aKin} × ${aBranch}（${brA}）`
        : `我方：${aBeast} × ${aKin} × ${aBranch}（${brA}）｜對方：${bBeast} × ${bKin} × ${bBranch}（${brB}）`;

      const strengths = Object.entries(scores).filter(([k,v])=>v>=70).map(([k])=>labelMap[k]).join('、') || '尚待養成';
      const weaknesses = Object.entries(scores).filter(([k,v])=>v<50).map(([k])=>labelMap[k]).join('、') || '無明顯弱項';

      div.innerHTML = `
        <h3 class="font-bold text-pink-600">${title}</h3>
        <p class="text-sm text-gray-600">${pairText}</p>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="p-3 rounded border bg-white">
            <div><b>情愛指數：</b>${loveIdx}/100</div>
            <div><b>辛香度（刺激）：</b>${spice}/100</div>
            <div><b>掌控度（規則/界線）：</b>${control}/100</div>
          </div>
          <div class="p-3 rounded border bg-white">
            <div><b>優勢面：</b>${strengths}</div>
            <div><b>風險面：</b>${weaknesses}</div>
          </div>
        </div>

        <div class="p-3 rounded border bg-white">
          <div class="font-semibold text-pink-700 mb-1">六獸語感</div>
          <ul class="list-disc pl-5 space-y-1 text-sm">
            <li><b>我方（${aBeast}）</b>：${A.vibe}；傾向${roleA}；偏好 ${kinkA}。</li>
            ${mode==='double' ? `<li><b>對方（${bBeast}）</b>：${B.vibe}；傾向${roleB}；偏好 ${kinkB}。</li>` : ''}
            <li><b>六親風格</b>：${kinA}${mode==='double' ? `｜${kinB}`:''}</li>
          </ul>
        </div>

        <div class="p-3 rounded border border-pink-200 bg-white">
          <div class="font-semibold text-pink-700 mb-1">三幕劇：故事化互動腳本</div>
          <ol class="list-decimal pl-5 space-y-2 text-sm leading-6">
            <li>${openLine("開場", aBeast, aBranch)} ${mode==='double' ? openLine("對方則", bBeast, bBranch) : ""}</li>
            <li>${midLine()}</li>
            <li>${closeLine()}</li>
          </ol>
        </div>

        ${paceOn ? `
        <div class="p-3 rounded border bg-white">
          <div class="font-semibold text-gray-700 mb-1">節奏建議（已開啟）</div>
          <p class="text-sm">採用「暖身→主段→收束」三段式；每段都保留『停頓 3 秒＋深呼吸 3 次』的回看點。</p>
        </div>` : ''}

        ${contextText ? `
        <div class="p-3 rounded border bg-white">
          <div class="font-semibold text-gray-700 mb-1">你的補充/界線</div>
          <p class="text-sm whitespace-pre-wrap">${escapeHTML(contextText)}</p>
        </div>` : ''}

        <div class="p-3 rounded border bg-white">
          <div class="font-semibold text-gray-700 mb-1">精準任務卡（可直接操作）</div>
          <ul class="list-disc pl-5 space-y-1 text-sm">
            ${tasks.map(t=>`<li>${t}</li>`).join('')}
          </ul>
        </div>

        <div class="p-3 rounded border bg-white">
          <div class="font-semibold text-gray-700 mb-1">可能地雷</div>
          <ul class="list-disc pl-5 space-y-1 text-sm">
            ${risks.map(r=>`<li>${r}</li>`).join('')}
          </ul>
        </div>
      `;

      return div;
    }

    // ------- 主流程：分析並更新畫面 -------
    function analyze() {
      const mode     = document.getElementById('mode').value;
      const scene    = document.getElementById('scene').value;
      const aBeast   = document.getElementById('aBeast').value;
      const aKin     = document.getElementById('aKin').value;
      const aBranch  = document.getElementById('aBranch').value;
      const bBeast   = document.getElementById('bBeast').value;
      const bKin     = document.getElementById('bKin').value;
      const bBranch  = document.getElementById('bBranch').value;
      const paceOn   = document.getElementById('ckPace').checked;
      const contextText = document.getElementById('context').value.trim();

      const keyBase = `${mode}|${scene}|${aBeast}-${aKin}-${aBranch}|${mode==='double' ? (bBeast+'-'+bKin+'-'+bBranch):''}`;

      // 初始分
      let comm   = scoreByKey(keyBase+'comm');
      let pace   = scoreByKey(keyBase+'pace',  0.45);
      let account= scoreByKey(keyBase+'acc',   0.48);
      let trust  = scoreByKey(keyBase+'trust', 0.50);
      let innov  = scoreByKey(keyBase+'innov', 0.50);
      let fit    = scoreByKey(keyBase+'fit',   0.52);

      // 六獸偏置：以我方為主，雙人時混合對方小量
      const ab = beastBias[aBeast] || {};
      comm  = applyBias(comm,  ab.comm  ?? 0);
      pace  = applyBias(pace,  ab.pace  ?? 0);
      account=applyBias(account,ab.account?? 0);
      trust = applyBias(trust, ab.trust ?? 0);
      innov = applyBias(innov, ab.innov ?? 0);

      if (mode==='double') {
        const bb = beastBias[bBeast] || {};
        comm  = applyBias(comm,  (bb.comm  ?? 0)*0.6);
        pace  = applyBias(pace,  (bb.pace  ?? 0)*0.6);
        account=applyBias(account,(bb.account?? 0)*0.6);
        trust = applyBias(trust, (bb.trust ?? 0)*0.6);
        innov = applyBias(innov, (bb.innov ?? 0)*0.6);

        // 情境影響：性愛更看契合/信任
        if (scene==='sex') {
          fit = Math.round((fit*0.7) + (comm*0.1) + (trust*0.2));
        } else {
          fit = Math.round((fit*0.8) + (comm*0.2));
        }
      }

      const scores = {comm, pace, account, trust, innov, fit};

      // 更新摘要
      const sum = document.getElementById('summary');
      sum.innerHTML = `
        <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
          <span class="px-2 py-1 rounded bg-indigo-50">模式：<b>${mode==='double'?'雙人':'單人'}</b></span>
          <span class="px-2 py-1 rounded bg-rose-50">我方：<b>${aBeast} × ${aKin} × ${aBranch}</b></span>
          ${mode==='double' ? `<span class="px-2 py-1 rounded bg-emerald-50">對方：<b>${bBeast} × ${bKin} × ${bBranch}</b></span>`:''}
          <span class="px-2 py-1 rounded bg-gray-100">情境：<b>${scene==='sex'?'性愛':scene==='relationship'?'關係/溝通':'一般'}</b></span>
        </div>
      `;

      // 更新雷達
      radarChart.data.datasets[0].data = [comm, pace, account, trust, innov, fit];
      radarChart.update();

      // 更新深度卡
      const cardHost = document.getElementById('deepCard');
      cardHost.innerHTML = '';
      cardHost.appendChild(buildSexDeepCard({
        mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch,
        scene, paceOn, contextText, scores
      }));

      document.getElementById('status').textContent = '分析完成';
    }

    // ------- 事件 -------
    document.getElementById('btnAnalyze').addEventListener('click', analyze);
    document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
    document.getElementById('mode').addEventListener('change', (e)=>{
      document.getElementById('bPanel').style.display = e.target.value==='double' ? '' : 'none';
    });
    // 初始化顯示
    document.getElementById('bPanel').style.display = document.getElementById('mode').value==='double' ? '' : 'none';
  </script>
</body>
</html>
