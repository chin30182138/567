<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ ä¸€éµåˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    @media print { @page { margin: 14mm; } .no-print { display:none !important; } body { background:#fff !important; } .print-card { box-shadow:none !important; border:1px solid #e5e7eb; } }
    .scores{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
    .score{display:flex;align-items:center;gap:10px;font-size:13px;color:#334155}
    .bar{flex:1;height:10px;background:#e2e8f0;border-radius:9999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:#6366f1}
    .score b{width:92px;display:inline-block;color:#0f172a}
    .score em{width:36px;text-align:right;color:#475569;font-style:normal}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:9999px;font-size:12px}
    .pill{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:9999px;padding:6px 10px;font-size:12px}
    .section-title{font-weight:700;margin-top:10px}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ï½œä¸€éµåˆ†æ</h1>
      <p class="text-slate-500 text-sm">é¸æ“‡åˆ†æå°è±¡ã€æƒ…å¢ƒ â†’ æŒ‰ã€Œä¸€éµåˆ†æã€ã€‚æ”¯æ´åˆ†æ•¸æ¢ã€é›·é”åœ–ã€åˆ—å° / åŒ¯å‡º PDFã€‚</p>
    </header>

    <!-- è‡ªå‹•åˆ¤æ–·å–®/é›™äººï¼ˆç„¡å°æ–¹ï¼å–®äººï¼›æœ‰å°æ–¹ï¼é›™äººï¼›é¸ã€Œå€‹æ€§åˆ†æã€äº¦è¦–ç‚ºå–®äººï¼‰ -->
    <div class="no-print">
      <div class="grid md:grid-cols-2 gap-4">
        <!-- æˆ‘æ–¹ -->
        <section class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">æˆ‘æ–¹ <span id="labelA" class="text-sm text-slate-500">(åˆ†æä¸»é«”)</span></h2>
          <select id="aBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­ç¸</option>
            <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
            <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
          </select>
          <select id="aKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­è¦ª</option>
            <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
            <option>å¦»è²¡</option><option>å®˜é¬¼</option>
          </select>
          <select id="aBranch" class="w-full border rounded-lg p-2">
            <option value="">åœ°æ”¯</option>
            <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
            <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
            <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
          </select>
        </section>

        <!-- å°æ–¹ï¼ˆè‹¥ç•™ç™½ï¼å–®äººï¼‰ -->
        <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">å°æ–¹ï¼ˆè‹¥ç•™ç™½ï¼å–®äººï¼‰</h2>
          <select id="bBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­ç¸</option>
            <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
            <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
          </select>
          <select id="bKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­è¦ª</option>
            <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
            <option>å¦»è²¡</option><option>å®˜é¬¼</option>
          </select>
          <select id="bBranch" class="w-full border rounded-lg p-2">
            <option value="">åœ°æ”¯</option>
            <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
            <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
            <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
          </select>
        </section>
      </div>
    </div>

    <!-- æƒ…å¢ƒ preset + è‡ªç”±è¼¸å…¥ -->
    <section class="bg-white p-4 rounded-2xl shadow-sm space-y-2 no-print">
      <h2 class="font-semibold">æƒ…å¢ƒ</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">å€‹æ€§åˆ†æ</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">å¹´åº¦ç›®æ¨™å”èª¿</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">ç¸¾æ•ˆå›é¥‹æœƒè­°</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">è·¨éƒ¨é–€å”ä½œ</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">å£“æœŸäº¤ä»˜å°ˆæ¡ˆ</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">äººéš›é—œä¿‚å”èª¿</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">æ„›æƒ…</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">æ€§æ„›</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="è¼¸å…¥æƒ…å¢ƒâ€¦" />

      <!-- æ€§æ„›æ·±å…¥åˆ†æï¼ˆå‹¾é¸ï¼›ééœ²éª¨ç‰ˆï¼‰ -->
      <div id="sexOptions" class="hidden mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center justify-between">
          <p class="font-semibold text-red-700">æ€§æ„›æƒ…å¢ƒæ·±å…¥åˆ†æï¼ˆééœ²éª¨ç‰ˆï¼‰</p>
          <span class="text-xs text-red-700/80">â€» è‘—é‡æºé€šã€åŒæ„ã€ç¯€å¥èˆ‡ç…§è­·</span>
        </div>

        <!-- å‹¾é¸ç¾¤çµ„ -->
        <div class="grid md:grid-cols-2 gap-3 mt-2">
          <fieldset class="border border-red-200 rounded-lg p-3">
            <legend class="text-sm font-semibold text-red-700">æƒ³è¦è‘—é‡çš„é¢å‘</legend>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="äº’å‹•ç¯€å¥èˆ‡é»˜å¥‘"> äº’å‹•ç¯€å¥èˆ‡é»˜å¥‘</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æƒ…å¢ƒé‹ªé™³èˆ‡æ°›åœ"> æƒ…å¢ƒé‹ªé™³èˆ‡æ°›åœ</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="å½¼æ­¤ä¸»å°èˆ‡å”å•†"> å½¼æ­¤ä¸»å°èˆ‡å”å•†</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="é‚Šç•Œã€åŒæ„èˆ‡å®‰å…¨è©"> é‚Šç•Œã€åŒæ„èˆ‡å®‰å…¨è©</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="äº‹å¾Œç…§è­·ï¼ˆaftercareï¼‰"> äº‹å¾Œç…§è­·ï¼ˆaftercareï¼‰</label>
          </fieldset>

          <fieldset class="border border-red-200 rounded-lg p-3">
            <legend class="text-sm font-semibold text-red-700">åå¥½é¢¨æ ¼</legend>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="éŠæˆ²æ„ŸæŒ‘é€—"> éŠæˆ²æ„ŸæŒ‘é€—</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æµªæ¼«æ·±æƒ…"> æµªæ¼«æ·±æƒ…</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æº«æŸ”å¼•å°"> æº«æŸ”å¼•å°</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æ™ºæ€§èª¿æƒ…"> æ™ºæ€§èª¿æƒ…</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="ç¯€å¥è®ŠåŒ–"> ç¯€å¥è®ŠåŒ–</label>
          </fieldset>
        </div>

        <textarea id="sexDetailInput" class="w-full mt-3 border rounded-lg p-2 text-sm" rows="3" placeholder="è£œå……ä½ æƒ³ç´å…¥çš„æƒ…å¢ƒæˆ–ç•Œç·šï¼ˆä¾‹ï¼šéŸ³æ¨‚ç‡ˆå…‰ã€å¯æ¥å—ï¼ä¸å¯æ¥å—ã€æºé€šæ–¹å¼â€¦ï¼‰"></textarea>
      </div>
    </section>

    <!-- å‹•ä½œåˆ— -->
    <div class="flex flex-wrap items-center gap-3 no-print">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">ä¸€éµåˆ†æ</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">åˆ—å° / åŒ¯å‡º PDF</button>
      <!-- ğŸ”» æ–°å¢ï¼šAI æ¨¡æ¿ç”¢ç”Ÿ & ä¸‹è¼‰ JSON -->
      <button id="genTpl" class="px-4 py-2 rounded-xl bg-rose-600 text-white">ç”¨ AI ç”¢ç”Ÿæ­¤çµ„åˆæ¨¡æ¿</button>
      <button id="saveTpl" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">ä¸‹è¼‰ç›®å‰æ¨¡æ¿ JSON</button>

      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- çµæœå€ -->
    <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
      <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
        <span class="px-3 py-1 bg-slate-100 rounded-full">æ¨¡å¼ï¼š<strong id="chipMode">â€”</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">æˆ‘æ–¹ï¼š<strong id="chipA">â€”</strong></span>
        <span id="chipB_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">å°æ–¹ï¼š<strong id="chipB">â€”</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">æƒ…å¢ƒï¼š<strong id="chipC">â€”</strong></span>
        <span id="chipSexDetail_wrapper" class="px-3 py-1 bg-slate-100 rounded-full hidden">æ·±å…¥ï¼š<strong id="chipSexDetail">â€”</strong></span>
      </div>

      <div id="result" class="prose max-w-none text-[15px]"></div>

      <!-- æ€§æ„›æ·±å…¥åˆ†æ -->
      <div id="sexDeep" class="mt-6 hidden">
        <h3 class="text-lg font-semibold">æ€§æ„›æ·±å…¥åˆ†æï¼ˆééœ²éª¨ï¼‰</h3>
        <div id="sexDeepBody" class="text-[15px] leading-7 mt-1"></div>
      </div>

      <div id="chart" class="mt-4"></div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // å…§å­˜ä¸­çš„æ¨¡æ¿å­—å…¸ï¼ˆå•Ÿå‹•æ™‚å¯å˜—è©¦è¼‰å…¥ /sex-templates.jsonï¼‰
    let TEMPLATES = {};
    (async () => {
      try {
        const r = await fetch('/sex-templates.json', { cache: 'no-store' });
        if (r.ok) TEMPLATES = await r.json();
      } catch {}
    })();

    function determineMode() {
      const hasB = ($('#bBeast').value && $('#bKin').value && $('#bBranch').value);
      const ctx = $('#context').value.trim();
      return (!hasB || ctx === 'å€‹æ€§åˆ†æ') ? 'single' : 'dual';
    }

    $$('.preset').forEach(b => b.onclick = () => {
      $('#context').value = b.textContent.trim();
      toggleSexOptions();
      updateChips(getSelections());
    });

    $('#context').oninput = toggleSexOptions;
    function toggleSexOptions() {
      const isSex = $('#context').value.trim() === 'æ€§æ„›';
      $('#sexOptions').classList.toggle('hidden', !isSex);
      if (!isSex) {
        $$('.sex-check').forEach(c => c.checked = false);
        $('#sexDetailInput').value = '';
        $('#chipSexDetail_wrapper').classList.add('hidden');
        $('#sexDeep').classList.add('hidden');
        $('#sexDeepBody').innerHTML = '';
      }
    }

    function getSelections(){
      const mode = determineMode();
      return {
        mode,
        aBeast: $('#aBeast').value, aKin: $('#aKin').value, aBranch: $('#aBranch').value,
        bBeast: $('#bBeast').value, bKin: $('#bKin').value, bBranch: $('#bBranch').value,
        context: $('#context').value.trim(),
        sexDetail: collectSexDetail()
      };
    }

    function collectSexDetail() {
      if ($('#context').value.trim() !== 'æ€§æ„›') return '';
      const picks = Array.from($$('.sex-check:checked')).map(c => c.value);
      const extra = $('#sexDetailInput').value.trim();
      const parts = [];
      if (picks.length) parts.push('é‡é»ï¼š' + picks.join('ã€'));
      if (extra) parts.push('è£œå……ï¼š' + extra);
      return parts.join('ï¼›');
    }

    function updateChips({mode, aBeast,aKin,aBranch,bBeast,bKin,bBranch,context, sexDetail}){
      $('#chipMode').textContent = mode === 'single' ? 'å–®äºº' : 'é›™äºº';
      $('#chipA').textContent = [aBeast,aKin,aBranch].filter(Boolean).join(' Ã— ') || 'â€”';
      if (mode === 'dual') {
        $('#chipB').textContent = [bBeast,bKin,bBranch].filter(Boolean).join(' Ã— ') || 'â€”';
        $('#chipB_wrapper').style.display = 'block';
      } else {
        $('#chipB_wrapper').style.display = 'none';
      }
      $('#chipC').textContent = context || 'â€”';
      if (context === 'æ€§æ„›' && sexDetail) {
        $('#chipSexDetail').textContent = sexDetail;
        $('#chipSexDetail_wrapper').classList.remove('hidden');
      } else {
        $('#chipSexDetail_wrapper').classList.add('hidden');
      }
    }

    function formatOutputWithJson(text){
      if(!text) return { html: '', scores: null, tags: [] };
      const jsonBlock = text.match(/```json([\s\S]*?)```/i);
      let json = null;
      if(jsonBlock){
        try{ json = JSON.parse(jsonBlock[1]); }catch(_){ json = null; }
        text = text.replace(jsonBlock[0], '').trim();
      }
      let scores = null;
      if (json && json.scores) {
        scores = json.scores;
      } else {
        const map = { fit:null, comm:null, pace:null, account:null, trust:null, innov:null };
        const rx = /(fit|comm|pace|account|trust|innov)\s*[:ï¼š]?\s*(\d{1,3})/ig;
        let m; while((m = rx.exec(text))){ map[m[1].toLowerCase()] = Number(m[2]); }
        const filled = Object.values(map).filter(v=>typeof v==='number' && !isNaN(v));
        if(filled.length>=2) scores = map;
      }
      let html = text
        .replace(/\n\s*\n/g, '\n')
        .replace(/^\s*\d+\)\s*(.+)$/gm, '<h3 class="text-lg font-semibold mt-4">$1</h3>')
        .replace(/^\s*[-â€“]\s*(.+)$/gm, '<li>$1</li>');
      html = html.replace(/(?:<li>[^<]*<\/li>\n?)+/g, m => `<ul class="list-disc pl-5 space-y-1">${m}</ul>`);
      if(scores && Object.values(scores).some(v => v !== null && !isNaN(v))){
        const s = scores; const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
        const row = (label, key, color) => `<div class="score"><b>${label}</b><div class="bar"><i style="width:${clamp(s[key])}%;background:${color}"></i></div><em>${clamp(s[key])}</em></div>`;
        const scoreHTML = `
          <h3 class="text-lg font-semibold mt-4">å…­ç¶­åº¦åˆ†æ•¸</h3>
          <div class="scores">
            ${row('å¥‘åˆ fit','fit','#22c55e')}
            ${row('æºé€š comm','comm','#06b6d4')}
            ${row('ç¯€å¥ pace','pace','#f59e0b')}
            ${row('æ¬Šè²¬ account','account','#8b5cf6')}
            ${row('ä¿¡ä»» trust','trust','#ef4444')}
            ${row('å‰µæ–° innov','innov','#6366f1')}
          </div>`;
        const tagsHTML = json && Array.isArray(json.tags) && json.tags.length ? `<div class="tags">${json.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>` : '';
        html = `${html}${scoreHTML}${tagsHTML}`;
      } else if (json && Array.isArray(json.tags) && json.tags.length) {
        const tagsHTML = `<div class="tags">${json.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>`;
        html = `${html}${tagsHTML}`;
      }
      return { html, scores, tags: (json && json.tags) ? json.tags : [] };
    }

    let radarChart = null;
    function renderRadar(scores){
      const wrap = document.getElementById('chart');
      wrap.innerHTML = '';
      if(!scores || Object.values(scores).every(v => v === null || isNaN(v))){ return; }
      const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
      const labels = ['å¥‘åˆ fit','æºé€š comm','ç¯€å¥ pace','æ¬Šè²¬ account','ä¿¡ä»» trust','å‰µæ–° innov'];
      const data = [clamp(scores.fit),clamp(scores.comm),clamp(scores.pace),clamp(scores.account),clamp(scores.trust),clamp(scores.innov)];
      const canvas = document.createElement('canvas'); canvas.id = 'radar'; wrap.appendChild(canvas);
      if(radarChart){ radarChart.destroy(); }
      radarChart = new Chart(canvas.getContext('2d'), {
        type: 'radar',
        data: { labels, datasets: [{ label: 'å…­ç¶­åº¦é›·é”åœ–', data, fill: true, backgroundColor: 'rgba(99,102,241,0.15)', borderColor: 'rgba(99,102,241,1)', pointBackgroundColor: 'rgba(99,102,241,1)'}] },
        options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } } }, plugins: { legend: { display: false } } }
      });
      window.radarChart = radarChart;
    }

    async function buildSexDeepCard(sel){
      const isSex = sel.context === 'æ€§æ„›';
      const box = $('#sexDeep');
      const body = $('#sexDeepBody');
      if(!isSex){ box.classList.add('hidden'); body.innerHTML=''; return; }

      const titleA = [sel.aBeast||'', sel.aBranch||''].join('');
      const titleB = sel.mode==='dual' ? [sel.bBeast||'', sel.bBranch||''].join('') : '';
      const key = titleB ? `${titleA}Ã—${titleB}` : "default";

      const tpl = TEMPLATES[key] || TEMPLATES["default"];
      if (!tpl) { body.innerHTML = `<em class="text-slate-500">å°šæœªæœ‰æ­¤çµ„åˆçš„æ¨¡æ¿ï¼Œå¯æŒ‰ã€Œç”¨ AI ç”¢ç”Ÿæ­¤çµ„åˆæ¨¡æ¿ã€ã€‚</em>`; box.classList.remove('hidden'); return; }

      const picks = (sel.sexDetail || '').replace(/^é‡é»ï¼š/,'').split('ï¼›')[0] || '';

      const html = `
        <div class="pill">çµ„åˆï¼š<b>${titleA}</b> ${titleB?`Ã— <b>${titleB}</b>`:''}</div>
        ${tpl.index ? `<div class="mt-2 text-[14px]"><span class="pill">${tpl.index}</span></div>` : ''}
        ${picks ? `<div class="mt-2 text-[14px]"><span class="pill">åå¥½é‡é»ï¼š${picks}</span></div>` : ''}

        ${tpl.title ? `<h4 class="section-title">${tpl.title}</h4>` : ''}

        <h4 class="section-title">äº’å‹•æ¨¡å¼</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.modes||[]).map(m=>`<li>${m}</li>`).join('')}</ul>

        <h4 class="section-title">æ½›åœ¨é›·é»</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.hotspots||[]).map(h=>`<li>${h}</li>`).join('')}</ul>

        <h4 class="section-title">åŠ‡æœ¬é¢¨æ ¼æ¨è–¦</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.scripts||[]).map(s=>`<li>${s}</li>`).join('')}</ul>

        <h4 class="section-title">æºé€šèˆ‡ç…§è­·</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.care||[]).map(c=>`<li>${c}</li>`).join('')}</ul>
      `;
      body.innerHTML = html;
      box.classList.remove('hidden');
    }

    // â€”â€” ã€Œç”¨ AI ç”¢ç”Ÿæ­¤çµ„åˆæ¨¡æ¿ã€ï¼šå‘¼å« /api/sex-template.js
    $('#genTpl').onclick = async () => {
      const aBeast = $('#aBeast').value, aBranch = $('#aBranch').value;
      const bBeast = $('#bBeast').value, bBranch = $('#bBranch').value;
      if (!aBeast || !aBranch) { alert('è«‹å…ˆé¸æ»¿æˆ‘æ–¹ã€Œå…­ç¸ã€åœ°æ”¯ã€'); return; }

      $('#status').textContent = 'AI ç”¢ç”Ÿæ¨¡æ¿ä¸­â€¦';
      try {
        const r = await fetch('/api/sex-template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ aBeast, aBranch, bBeast, bBranch })
        });
        const { template } = await r.json();
        if (!template || !template.key) throw new Error('ç„¡æ•ˆæ¨¡æ¿');

        // å¯«å…¥å…§å­˜å­—å…¸
        TEMPLATES[template.key] = {
          title: template.title || 'ä¸€èˆ¬äº’å‹•æ¨¡æ¿',
          index: template.index || 'äº’å‹•æŒ‡æ•¸ï¼š8.0/10',
          modes: Array.isArray(template.modes) ? template.modes : [],
          hotspots: Array.isArray(template.hotspots) ? template.hotspots : [],
          scripts: Array.isArray(template.scripts) ? template.scripts : [],
          care: Array.isArray(template.care) ? template.care : []
        };

        // è‹¥æ­£åœ¨çœ‹ã€Œæ€§æ„›ã€é é¢ï¼Œç«‹åˆ»å±•ç¤º
        const sel = getSelections();
        await buildSexDeepCard(sel);

        $('#status').textContent = `âœ… å·²æ–°å¢æ¨¡æ¿ï¼š${template.key}`;
      } catch (e) {
        console.error(e);
        $('#status').textContent = 'âŒ æ¨¡æ¿ç”¢ç”Ÿå¤±æ•—';
        alert('ç”¢ç”Ÿå¤±æ•—ï¼šè«‹ç¢ºèªå·²éƒ¨ç½² /api/sex-template ä¸¦è¨­å®š OPENAI_API_KEYã€‚');
      }
    };

    // â€”â€” ã€Œä¸‹è¼‰ç›®å‰æ¨¡æ¿ JSONã€
    $('#saveTpl').onclick = () => {
      const blob = new Blob([JSON.stringify(TEMPLATES, null, 2)], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sex-templates.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    // ä¸€éµåˆ†æï¼ˆæ²¿ç”¨ä½ åŸå…ˆæµç¨‹ï¼‰
    $('#go').onclick = async () => {
      const sel = getSelections();
      updateChips(sel);

      const needA = sel.aBeast && sel.aKin && sel.aBranch;
      const needB = sel.mode === 'dual' ? (sel.bBeast && sel.bKin && sel.bBranch) : true;
      const needC = !!sel.context;
      if(!needA || !needB || !needC){
        alert(sel.mode==='dual' ? 'é›™äººåˆ†æï¼šè«‹å…ˆé¸æ»¿æˆ‘æ–¹/å°æ–¹ã€Œå…­ç¸ã€å…­è¦ªã€åœ°æ”¯ã€èˆ‡æƒ…å¢ƒ' : 'å–®äººåˆ†æï¼šè«‹å…ˆé¸æ»¿æˆ‘æ–¹ã€Œå…­ç¸ã€å…­è¦ªã€åœ°æ”¯ã€èˆ‡æƒ…å¢ƒ');
        return;
      }

      $('#status').textContent = 'åˆ†æä¸­â€¦';
      $('#result').innerHTML = '';
      $('#chart').innerHTML = '';
      $('#sexDeep').classList.add('hidden');

      try {
        const res = await fetch('/api/analyze', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(sel)
        });
        const data = await res.json();
        let plain = data.text || data.result;
        if(!plain && Array.isArray(data.output)){
          plain = data.output.map(o=> (o.content||[]).map(c=>c.text||'').join('\n')).join('\n');
        }
        if(!plain) plain = JSON.stringify(data, null, 2);

        const formatted = formatOutputWithJson(plain);
        $('#result').innerHTML = formatted.html;
        renderRadar(formatted.scores);
        await buildSexDeepCard(sel);

        $('#status').textContent = 'âœ… å®Œæˆ';
      } catch (e) {
        $('#status').textContent = 'âŒ å¤±æ•—';
        $('#result').textContent = String(e);
      }
    };

    // åˆ—å° / åŒ¯å‡º PDF
    $('#print').onclick = () => {
      const sel = getSelections();
      updateChips(sel);
      const chartImg = (window.radarChart && window.radarChart.canvas) ? window.radarChart.canvas.toDataURL('image/png') : '';
      const html = `<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"><title>åˆ—å°</title>
      <style>
        body{font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC";color:#0f172a;margin:18px;}
        h1{font-size:20px;margin:0 0 6px;}
        .meta{color:#64748b;font-size:12px;margin-bottom:10px}
        .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
        .chip{background:#eef2f7;border-radius:9999px;padding:6px 10px;font-size:12px;color:#0f172a}
        .box{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
        .result{font-size:14px;line-height:1.6}
        ul{margin:6px 0 6px 18px}
        h3{margin:10px 0 4px}
        .chart{margin-top:12px;text-align:center}
        .chart img{max-width:520px;width:100%;}
        @page{margin:14mm}
      </style></head><body>
      <h1>ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼</h1>
      <div class="meta">ç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString()}</div>
      <div class="chips">
        <span class="chip">æ¨¡å¼ï¼š${sel.mode === 'single' ? 'å–®äºº' : 'é›™äºº'}</span>
        <span class="chip">æˆ‘æ–¹ï¼š${[sel.aBeast||'â€”', sel.aKin||'â€”', sel.aBranch||'â€”'].filter(Boolean).join(' Ã— ')}</span>
        ${sel.mode === 'dual' ? `<span class="chip">å°æ–¹ï¼š${[sel.bBeast||'â€”', sel.bKin||'â€”', sel.bBranch||'â€”'].filter(Boolean).join(' Ã— ')}</span>` : ''}
        <span class="chip">æƒ…å¢ƒï¼š${sel.context||'â€”'}</span>
        ${sel.context === 'æ€§æ„›' && sel.sexDetail ? `<span class="chip">æ·±å…¥ï¼š${sel.sexDetail}</span>` : ''}
      </div>
      <div class="box">
        <div class="result">${$('#result').innerHTML || '<em>å°šæœªç”¢ç”Ÿçµæœ</em>'}</div>
        ${ (sel.context==='æ€§æ„›' && $('#sexDeep').classList.contains('hidden')===false) ? `<hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb" />
          <div class="result">${$('#sexDeep').innerHTML}</div>` : '' }
        ${chartImg ? `<div class="chart"><img src="${chartImg}" alt="é›·é”åœ–"></div>` : ''}
      </div>
      <script>window.onload=()=>window.print()<\/script></body></html>`;
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
    };

    // åˆå§‹åŒ–
    toggleSexOptions();
    updateChips(getSelections());
  </script>
</body>
</html>
<!-- ==========================
   æ–‡ä»¶ï¼šindex.html ï¼ˆå®Œæ•´ç‰ˆï½œæƒ…å¢ƒå«ã€Œå€‹æ€§åˆ†æã€ï¼›æ€§æ„›æ·±å…¥åˆ†æï¼å‹¾é¸ï¼‹å¤–éƒ¨ JSON æ¨¡æ¿è¼‰å…¥ï¼‰
   ========================== -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ ä¸€éµåˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    @media print {
      @page { margin: 14mm; }
      .no-print { display:none !important; }
      body { background:#fff !important; }
      .print-card { box-shadow:none !important; border:1px solid #e5e7eb; }
    }
    .scores{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
    .score{display:flex;align-items:center;gap:10px;font-size:13px;color:#334155}
    .bar{flex:1;height:10px;background:#e2e8f0;border-radius:9999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:#6366f1}
    .score b{width:92px;display:inline-block;color:#0f172a}
    .score em{width:36px;text-align:right;color:#475569;font-style:normal}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:9999px;font-size:12px}
    .pill{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:9999px;padding:6px 10px;font-size:12px}
    .section-title{font-weight:700;margin-top:10px}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ï½œä¸€éµåˆ†æ</h1>
      <p class="text-slate-500 text-sm">é¸æ“‡åˆ†æå°è±¡ã€æƒ…å¢ƒ â†’ æŒ‰ã€Œä¸€éµåˆ†æã€ã€‚æ”¯æ´åˆ†æ•¸æ¢ã€é›·é”åœ–ã€åˆ—å° / åŒ¯å‡º PDFã€‚</p>
    </header>

    <!-- è‡ªå‹•åˆ¤æ–·å–®/é›™äººï¼ˆç„¡å°æ–¹ï¼å–®äººï¼›æœ‰å°æ–¹ï¼é›™äººï¼›é¸ã€Œå€‹æ€§åˆ†æã€äº¦è¦–ç‚ºå–®äººï¼‰ -->
    <div class="no-print">
      <div class="grid md:grid-cols-2 gap-4">
        <!-- æˆ‘æ–¹ -->
        <section class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">æˆ‘æ–¹ <span id="labelA" class="text-sm text-slate-500">(åˆ†æä¸»é«”)</span></h2>
          <select id="aBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­ç¸</option>
            <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
            <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
          </select>
          <select id="aKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­è¦ª</option>
            <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
            <option>å¦»è²¡</option><option>å®˜é¬¼</option>
          </select>
          <select id="aBranch" class="w-full border rounded-lg p-2">
            <option value="">åœ°æ”¯</option>
            <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
            <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
            <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
          </select>
        </section>

        <!-- å°æ–¹ï¼ˆè‹¥ç•™ç™½ï¼å–®äººï¼‰ -->
        <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
          <h2 class="font-semibold mb-3">å°æ–¹ï¼ˆè‹¥ç•™ç™½ï¼å–®äººï¼‰</h2>
          <select id="bBeast" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­ç¸</option>
            <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
            <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
          </select>
          <select id="bKin" class="w-full mb-2 border rounded-lg p-2">
            <option value="">å…­è¦ª</option>
            <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
            <option>å¦»è²¡</option><option>å®˜é¬¼</option>
          </select>
          <select id="bBranch" class="w-full border rounded-lg p-2">
            <option value="">åœ°æ”¯</option>
            <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
            <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
            <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
          </select>
        </section>
      </div>
    </div>

    <!-- æƒ…å¢ƒ preset + è‡ªç”±è¼¸å…¥ -->
    <section class="bg-white p-4 rounded-2xl shadow-sm space-y-2 no-print">
      <h2 class="font-semibold">æƒ…å¢ƒ</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">å€‹æ€§åˆ†æ</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">å¹´åº¦ç›®æ¨™å”èª¿</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">ç¸¾æ•ˆå›é¥‹æœƒè­°</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">è·¨éƒ¨é–€å”ä½œ</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">å£“æœŸäº¤ä»˜å°ˆæ¡ˆ</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">äººéš›é—œä¿‚å”èª¿</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">æ„›æƒ…</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">æ€§æ„›</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="è¼¸å…¥æƒ…å¢ƒâ€¦" />

      <!-- æ€§æ„›æ·±å…¥åˆ†æï¼ˆå‹¾é¸ï¼›ééœ²éª¨ç‰ˆï¼‰ -->
      <div id="sexOptions" class="hidden mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center justify-between">
          <p class="font-semibold text-red-700">æ€§æ„›æƒ…å¢ƒæ·±å…¥åˆ†æï¼ˆééœ²éª¨ç‰ˆï¼‰</p>
          <span class="text-xs text-red-700/80">â€» è‘—é‡æºé€šã€åŒæ„ã€ç¯€å¥èˆ‡ç…§è­·</span>
        </div>

        <!-- å‹¾é¸ç¾¤çµ„ -->
        <div class="grid md:grid-cols-2 gap-3 mt-2">
          <fieldset class="border border-red-200 rounded-lg p-3">
            <legend class="text-sm font-semibold text-red-700">æƒ³è¦è‘—é‡çš„é¢å‘</legend>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="äº’å‹•ç¯€å¥èˆ‡é»˜å¥‘"> äº’å‹•ç¯€å¥èˆ‡é»˜å¥‘</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æƒ…å¢ƒé‹ªé™³èˆ‡æ°›åœ"> æƒ…å¢ƒé‹ªé™³èˆ‡æ°›åœ</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="å½¼æ­¤ä¸»å°èˆ‡å”å•†"> å½¼æ­¤ä¸»å°èˆ‡å”å•†</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="é‚Šç•Œã€åŒæ„èˆ‡å®‰å…¨è©"> é‚Šç•Œã€åŒæ„èˆ‡å®‰å…¨è©</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="äº‹å¾Œç…§è­·ï¼ˆaftercareï¼‰"> äº‹å¾Œç…§è­·ï¼ˆaftercareï¼‰</label>
          </fieldset>

          <fieldset class="border border-red-200 rounded-lg p-3">
            <legend class="text-sm font-semibold text-red-700">åå¥½é¢¨æ ¼</legend>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="éŠæˆ²æ„ŸæŒ‘é€—"> éŠæˆ²æ„ŸæŒ‘é€—</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æµªæ¼«æ·±æƒ…"> æµªæ¼«æ·±æƒ…</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æº«æŸ”å¼•å°"> æº«æŸ”å¼•å°</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="æ™ºæ€§èª¿æƒ…"> æ™ºæ€§èª¿æƒ…</label>
            <label class="block mt-2"><input type="checkbox" class="sex-check" value="ç¯€å¥è®ŠåŒ–"> ç¯€å¥è®ŠåŒ–</label>
          </fieldset>
        </div>

        <textarea id="sexDetailInput" class="w-full mt-3 border rounded-lg p-2 text-sm" rows="3" placeholder="è£œå……ä½ æƒ³ç´å…¥çš„æƒ…å¢ƒæˆ–ç•Œç·šï¼ˆä¾‹ï¼šéŸ³æ¨‚ç‡ˆå…‰ã€å¯æ¥å—ï¼ä¸å¯æ¥å—ã€æºé€šæ–¹å¼â€¦ï¼‰"></textarea>
      </div>
    </section>

    <!-- å‹•ä½œåˆ— -->
    <div class="flex flex-wrap items-center gap-3 no-print">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">ä¸€éµåˆ†æ</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">åˆ—å° / åŒ¯å‡º PDF</button>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- çµæœå€ -->
    <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
      <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
        <span class="px-3 py-1 bg-slate-100 rounded-full">æ¨¡å¼ï¼š<strong id="chipMode">â€”</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">æˆ‘æ–¹ï¼š<strong id="chipA">â€”</strong></span>
        <span id="chipB_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">å°æ–¹ï¼š<strong id="chipB">â€”</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">æƒ…å¢ƒï¼š<strong id="chipC">â€”</strong></span>
        <span id="chipSexDetail_wrapper" class="px-3 py-1 bg-slate-100 rounded-full hidden">æ·±å…¥ï¼š<strong id="chipSexDetail">â€”</strong></span>
      </div>

      <!-- AI åˆ†ææ–‡å­— -->
      <div id="result" class="prose max-w-none text-[15px]"></div>

      <!-- æ€§æ„›æ·±å…¥åˆ†æï¼ˆè¼‰å…¥å¤–éƒ¨ JSON æ¨¡æ¿ï¼Œééœ²éª¨ï¼‰ -->
      <div id="sexDeep" class="mt-6 hidden">
        <h3 class="text-lg font-semibold">æ€§æ„›æ·±å…¥åˆ†æï¼ˆééœ²éª¨ï¼‰</h3>
        <div id="sexDeepBody" class="text-[15px] leading-7 mt-1"></div>
      </div>

      <!-- é›·é”åœ– -->
      <div id="chart" class="mt-4"></div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // â€”â€” è‡ªå‹•åˆ¤æ–·å–®/é›™äººï¼ˆç„¡å°æ–¹ï¼singleï¼›æœ‰å°æ–¹ï¼dualï¼›é¸ã€Œå€‹æ€§åˆ†æã€äº¦è¦–ç‚º singleï¼‰
    function determineMode() {
      const hasB = ($('#bBeast').value && $('#bKin').value && $('#bBranch').value);
      const ctx = $('#context').value.trim();
      return (!hasB || ctx === 'å€‹æ€§åˆ†æ') ? 'single' : 'dual';
    }

    // æƒ…å¢ƒ presets
    $$('.preset').forEach(b => b.onclick = () => {
      $('#context').value = b.textContent.trim();
      toggleSexOptions();
      updateChips(getSelections());
    });

    // æ€§æ„›é¸é …é¡¯ç¤º
    $('#context').oninput = toggleSexOptions;
    function toggleSexOptions() {
      const isSex = $('#context').value.trim() === 'æ€§æ„›';
      $('#sexOptions').classList.toggle('hidden', !isSex);
      if (!isSex) {
        $$('.sex-check').forEach(c => c.checked = false);
        $('#sexDetailInput').value = '';
        $('#chipSexDetail_wrapper').classList.add('hidden');
        $('#sexDeep').classList.add('hidden');
        $('#sexDeepBody').innerHTML = '';
      }
    }

    function getSelections(){
      const mode = determineMode();
      return {
        mode,
        aBeast: $('#aBeast').value, aKin: $('#aKin').value, aBranch: $('#aBranch').value,
        bBeast: $('#bBeast').value, bKin: $('#bKin').value, bBranch: $('#bBranch').value,
        context: $('#context').value.trim(),
        sexDetail: collectSexDetail() // å‹¾é¸ï¼‹æ–‡å­—æ‘˜è¦
      };
    }

    function collectSexDetail() {
      if ($('#context').value.trim() !== 'æ€§æ„›') return '';
      const picks = Array.from($$('.sex-check:checked')).map(c => c.value);
      const extra = $('#sexDetailInput').value.trim();
      const parts = [];
      if (picks.length) parts.push('é‡é»ï¼š' + picks.join('ã€'));
      if (extra) parts.push('è£œå……ï¼š' + extra);
      return parts.join('ï¼›');
    }

    function updateChips({mode, aBeast,aKin,aBranch,bBeast,bKin,bBranch,context, sexDetail}){
      $('#chipMode').textContent = mode === 'single' ? 'å–®äºº' : 'é›™äºº';
      $('#chipA').textContent = [aBeast,aKin,aBranch].filter(Boolean).join(' Ã— ') || 'â€”';
      if (mode === 'dual') {
        $('#chipB').textContent = [bBeast,bKin,bBranch].filter(Boolean).join(' Ã— ') || 'â€”';
        $('#chipB_wrapper').style.display = 'block';
      } else {
        $('#chipB_wrapper').style.display = 'none';
      }
      $('#chipC').textContent = context || 'â€”';

      if (context === 'æ€§æ„›' && sexDetail) {
        $('#chipSexDetail').textContent = sexDetail;
        $('#chipSexDetail_wrapper').classList.remove('hidden');
      } else {
        $('#chipSexDetail_wrapper').classList.add('hidden');
      }
    }

    // æ–‡å­—â†’HTMLï¼‹JSONï¼ˆåˆ†æ•¸æ¢/æ¨™ç±¤ï¼‰
    function formatOutputWithJson(text){
      if(!text) return { html: '', scores: null, tags: [] };

      const jsonBlock = text.match(/```json([\s\S]*?)```/i);
      let json = null;
      if(jsonBlock){
        try{ json = JSON.parse(jsonBlock[1]); }catch(_){ json = null; }
        text = text.replace(jsonBlock[0], '').trim();
      }

      let scores = null;
      if (json && json.scores) {
        scores = json.scores;
      } else {
        const map = { fit:null, comm:null, pace:null, account:null, trust:null, innov:null };
        const rx = /(fit|comm|pace|account|trust|innov)\s*[:ï¼š]?\s*(\d{1,3})/ig;
        let m; while((m = rx.exec(text))){ map[m[1].toLowerCase()] = Number(m[2]); }
        const filled = Object.values(map).filter(v=>typeof v==='number' && !isNaN(v));
        if(filled.length>=2) scores = map;
      }

      let html = text
        .replace(/\n\s*\n/g, '\n')
        .replace(/^\s*\d+\)\s*(.+)$/gm, '<h3 class="text-lg font-semibold mt-4">$1<\/h3>')
        .replace(/^\s*[-â€“]\s*(.+)$/gm, '<li>$1<\/li>');
      html = html.replace(/(?:<li>[^<]*<\/li>\n?)+/g, m => `<ul class="list-disc pl-5 space-y-1">${m}<\/ul>`);

      if(scores && Object.values(scores).some(v => v !== null && !isNaN(v))){
        const s = scores; const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
        const row = (label, key, color) => `<div class=\"score\"><b>${label}<\/b><div class=\"bar\"><i style=\"width:${clamp(s[key])}%;background:${color}\"><\/i><\/div><em>${clamp(s[key])}<\/em><\/div>`;
        const scoreHTML = `
          <h3 class=\"text-lg font-semibold mt-4\">å…­ç¶­åº¦åˆ†æ•¸<\/h3>
          <div class=\"scores\">
            ${row('å¥‘åˆ fit','fit','#22c55e')}
            ${row('æºé€š comm','comm','#06b6d4')}
            ${row('ç¯€å¥ pace','pace','#f59e0b')}
            ${row('æ¬Šè²¬ account','account','#8b5cf6')}
            ${row('ä¿¡ä»» trust','trust','#ef4444')}
            ${row('å‰µæ–° innov','innov','#6366f1')}
          <\/div>`;
        const tagsHTML = json && Array.isArray(json.tags) && json.tags.length ? `<div class=\"tags\">${json.tags.map(t=>`<span class=\\\"tag\\\">${t}<\/span>`).join('')}<\/div>` : '';
        html = `${html}${scoreHTML}${tagsHTML}`;
      } else if (json && Array.isArray(json.tags) && json.tags.length) {
        const tagsHTML = `<div class=\"tags\">${json.tags.map(t=>`<span class=\\\"tag\\\">${t}<\/span>`).join('')}<\/div>`;
        html = `${html}${tagsHTML}`;
      }

      return { html, scores, tags: (json && json.tags) ? json.tags : [] };
    }

    // Radar åœ–
    let radarChart = null;
    function renderRadar(scores){
      const wrap = document.getElementById('chart');
      wrap.innerHTML = '';
      if(!scores || Object.values(scores).every(v => v === null || isNaN(v))){ return; }
      const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
      const labels = ['å¥‘åˆ fit','æºé€š comm','ç¯€å¥ pace','æ¬Šè²¬ account','ä¿¡ä»» trust','å‰µæ–° innov'];
      const data = [clamp(scores.fit),clamp(scores.comm),clamp(scores.pace),clamp(scores.account),clamp(scores.trust),clamp(scores.innov)];
      const canvas = document.createElement('canvas'); canvas.id = 'radar'; wrap.appendChild(canvas);
      if(radarChart){ radarChart.destroy(); }
      radarChart = new Chart(canvas.getContext('2d'), {
        type: 'radar',
        data: { labels, datasets: [{ label: 'å…­ç¶­åº¦é›·é”åœ–', data, fill: true, backgroundColor: 'rgba(99,102,241,0.15)', borderColor: 'rgba(99,102,241,1)', pointBackgroundColor: 'rgba(99,102,241,1)'}] },
        options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } } }, plugins: { legend: { display: false } } }
      });
      window.radarChart = radarChart; // ä¾›åˆ—å°ç”¨
    }

    // â€”â€” æ€§æ„›æ·±å…¥åˆ†æï¼šè¼‰å…¥å¤–éƒ¨ JSON æ¨¡æ¿ï¼ˆééœ²éª¨ç‰ˆï¼›ä¹‹å¾Œå¯ç”±ä½ è‡ªè¡Œæ›¿æ›ï¼‰
    async function buildSexDeepCard(sel){
      const isSex = sel.context === 'æ€§æ„›';
      const box = $('#sexDeep');
      const body = $('#sexDeepBody');
      if(!isSex){ box.classList.add('hidden'); body.innerHTML=''; return; }

      const titleA = [sel.aBeast||'', sel.aBranch||''].join('');
      const titleB = sel.mode==='dual' ? [sel.bBeast||'', sel.bBranch||''].join('') : '';
      const key = titleB ? `${titleA}Ã—${titleB}` : "default";

      // è¼‰å…¥æ¨¡æ¿
      let templates = {};
      try {
        const r = await fetch('/sex-templates.json', { cache: 'no-store' });
        templates = await r.json();
      } catch(e){ console.error("è¼‰å…¥ sex-templates.json å¤±æ•—", e); }

      const tpl = templates[key] || templates["default"] || {};
      const picks = (sel.sexDetail || '').replace(/^é‡é»ï¼š/,'').split('ï¼›')[0] || '';

      const html = `
        <div class="pill">çµ„åˆï¼š<b>${titleA}</b> ${titleB?`Ã— <b>${titleB}</b>`:''}</div>
        ${tpl.index ? `<div class="mt-2 text-[14px]"><span class="pill">${tpl.index}</span></div>` : ''}
        ${picks ? `<div class="mt-2 text-[14px]"><span class="pill">åå¥½é‡é»ï¼š${picks}</span></div>` : ''}

        ${tpl.title ? `<h4 class="section-title">${tpl.title}</h4>` : ''}

        <h4 class="section-title">äº’å‹•æ¨¡å¼</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.modes||[]).map(m=>`<li>${m}</li>`).join('')}</ul>

        <h4 class="section-title">æ½›åœ¨é›·é»</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.hotspots||[]).map(h=>`<li>${h}</li>`).join('')}</ul>

        <h4 class="section-title">åŠ‡æœ¬é¢¨æ ¼æ¨è–¦</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.scripts||[]).map(s=>`<li>${s}</li>`).join('')}</ul>

        <h4 class="section-title">æºé€šèˆ‡ç…§è­·</h4>
        <ul class="list-disc pl-5 space-y-1">${(tpl.care||[]).map(c=>`<li>${c}</li>`).join('')}</ul>
      `;

      body.innerHTML = html;
      box.classList.remove('hidden');
    }

    // ä¸€éµåˆ†æ
    $('#go').onclick = async () => {
      const sel = getSelections();
      updateChips(sel);

      // é©—è­‰ï¼šæˆ‘æ–¹å¿…å¡«ï¼›è‹¥ç‚ºé›™äººéœ€å¡«å°æ–¹ï¼›æƒ…å¢ƒå¿…å¡«
      const needA = sel.aBeast && sel.aKin && sel.aBranch;
      const needB = sel.mode === 'dual' ? (sel.bBeast && sel.bKin && sel.bBranch) : true;
      const needC = !!sel.context;
      if(!needA || !needB || !needC){
        alert(sel.mode==='dual' ? 'é›™äººåˆ†æï¼šè«‹å…ˆé¸æ»¿æˆ‘æ–¹/å°æ–¹ã€Œå…­ç¸ã€å…­è¦ªã€åœ°æ”¯ã€èˆ‡æƒ…å¢ƒ' : 'å–®äººåˆ†æï¼šè«‹å…ˆé¸æ»¿æˆ‘æ–¹ã€Œå…­ç¸ã€å…­è¦ªã€åœ°æ”¯ã€èˆ‡æƒ…å¢ƒ');
        return;
      }

      $('#status').textContent = 'åˆ†æä¸­â€¦';
      $('#result').innerHTML = '';
      $('#chart').innerHTML = '';
      $('#sexDeep').classList.add('hidden');

      try {
        const res = await fetch('/api/analyze', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(sel)
        });
        const data = await res.json();
        let plain = data.text || data.result;
        if(!plain && Array.isArray(data.output)){
          plain = data.output.map(o=> (o.content||[]).map(c=>c.text||'').join('\n')).join('\n');
        }
        if(!plain) plain = JSON.stringify(data, null, 2);

        const formatted = formatOutputWithJson(plain);
        $('#result').innerHTML = formatted.html;
        renderRadar(formatted.scores);
        await buildSexDeepCard(sel); // ä¾å‹¾é¸ï¼‹çµ„åˆè¼‰å…¥æ¨¡æ¿

        $('#status').textContent = 'âœ… å®Œæˆ';
      } catch (e) {
        $('#status').textContent = 'âŒ å¤±æ•—';
        $('#result').textContent = String(e);
      }
    };

    // åˆ—å° / åŒ¯å‡º PDFï¼ˆå¸¶å…¥é›·é”åœ–å¿«ç…§èˆ‡æ€§æ„›å¡ï¼‰
    $('#print').onclick = () => {
      const sel = getSelections();
      updateChips(sel);

      const chartImg = (window.radarChart && window.radarChart.canvas) ? window.radarChart.canvas.toDataURL('image/png') : '';
      const html = `<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"><title>åˆ—å°</title>
      <style>
        body{font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC";color:#0f172a;margin:18px;}
        h1{font-size:20px;margin:0 0 6px;}
        .meta{color:#64748b;font-size:12px;margin-bottom:10px}
        .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
        .chip{background:#eef2f7;border-radius:9999px;padding:6px 10px;font-size:12px;color:#0f172a}
        .box{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
        .result{font-size:14px;line-height:1.6}
        ul{margin:6px 0 6px 18px}
        h3{margin:10px 0 4px}
        .chart{margin-top:12px;text-align:center}
        .chart img{max-width:520px;width:100%;}
        @page{margin:14mm}
      </style></head><body>
      <h1>ä»™äººæŒ‡è·¯ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼</h1>
      <div class="meta">ç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString()}</div>
      <div class="chips">
        <span class="chip">æ¨¡å¼ï¼š${sel.mode === 'single' ? 'å–®äºº' : 'é›™äºº'}</span>
        <span class="chip">æˆ‘æ–¹ï¼š${[sel.aBeast||'â€”', sel.aKin||'â€”', sel.aBranch||'â€”'].filter(Boolean).join(' Ã— ')}</span>
        ${sel.mode === 'dual' ? `<span class="chip">å°æ–¹ï¼š${[sel.bBeast||'â€”', sel.bKin||'â€”', sel.bBranch||'â€”'].filter(Boolean).join(' Ã— ')}</span>` : ''}
        <span class="chip">æƒ…å¢ƒï¼š${sel.context||'â€”'}</span>
        ${sel.context === 'æ€§æ„›' && sel.sexDetail ? `<span class="chip">æ·±å…¥ï¼š${sel.sexDetail}</span>` : ''}
      </div>
      <div class="box">
        <div class="result">${$('#result').innerHTML || '<em>å°šæœªç”¢ç”Ÿçµæœ</em>'}</div>
        ${ (sel.context==='æ€§æ„›' && $('#sexDeep').classList.contains('hidden')===false) ? `<hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb" />
          <div class="result">${$('#sexDeep').innerHTML}</div>` : '' }
        ${chartImg ? `<div class="chart"><img src="${chartImg}" alt="é›·é”åœ–"></div>` : ''}
      </div>
      <script>window.onload=()=>window.print()<\/script></body></html>`;
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
    };

    // é é¢åˆå§‹åŒ–
    toggleSexOptions();
    updateChips(getSelections());
  </script>
</body>
</html>

