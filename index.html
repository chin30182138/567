// ====== 語感模板庫（六獸 × 六親 × 地支）======
const SEX_BEAST_TONE = {
  "青龍": { vibe: "靈活主動、擅長逗引與變速", lead: "以節奏與花樣主導", kink: "遊戲規則、角色扮演" },
  "朱雀": { vibe: "語言挑逗、火熱外放", lead: "靠聲音與眼神牽引", kink: "言語命令、舞台感" },
  "勾陳": { vibe: "穩健鋪陳、重儀式感與安全", lead: "以流程與步驟掌控", kink: "前戲儀式、慢慢累積" },
  "螣蛇": { vibe: "神秘勾魂、張弛交替", lead: "以忽近忽遠吊足胃口", kink: "遮眼與感官轉換" },
  "白虎": { vibe: "直接果決、控制欲強", lead: "以力度與關鍵節點掌控", kink: "主導/臣服邊界遊戲" },
  "玄武": { vibe: "安靜深沉、重包覆與信任", lead: "以穩定能量收攏節奏", kink: "長時擁抱、深呼吸同步" }
};

const SEX_KIN_DYNAMICS = {
  "父母":  "傾向照顧與引導，容易把節奏當『教學』；需留意別過度糾正。",
  "兄弟":  "互不服輸、較量意味濃厚；競賽式挑逗能迅速升溫。",
  "子孫":  "玩心重、求新求變；用遊戲規則與任務卡最好使。",
  "妻財":  "交換與回饋明確；『你給我什麼、我回你什麼』很管用。",
  "官鬼":  "權力張力強，主從角色最容易啟動；需先談好界線。",
};

const BRANCH_FLAVOR = {
  "子": "偏水：冷熱落差敏感，喜暗光與耳語。",
  "丑": "偏土：需要場地與靠墊支撐，穩定後才放開。",
  "寅": "偏木：開場快、越玩越上手；喜路線規畫。",
  "卯": "偏木：重氛圍與美感，節奏要順暢無卡點。",
  "辰": "土混：容易想太多；先定規則再上場會更自在。",
  "巳": "偏火：升溫快、爆發力強；要設安全詞。",
  "午": "純火：舞台感最強，燈光與音樂一上就進狀態。",
  "未": "偏土：慢熱但續航好；喜長時間鋪陳與收束。",
  "申": "金水交：對細節敏感，喜精準節拍與巧妙停頓。",
  "酉": "偏金：儀容與道具要到位；偏好乾淨俐落的轉場。",
  "戌": "燥土：需要被說服與認可；先談期待再點火。",
  "亥": "純水：情緒流很重要；以擁抱與貼近帶入最穩。"
};

// ====== 升級版：性愛深度分析卡 ======
function buildSexDeepCard(model) {
  const {
    mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch,
    scene, paceOn, contextText, scores
  } = model;

  // 指標運算
  const loveIdx = Math.round((scores.fit * 0.6) + (scores.trust * 0.4));
  const spice   = Math.round((scores.innov * 0.5) + (scores.pace * 0.3) + (scores.comm * 0.2));
  const control = Math.round((scores.account * 0.5) + (scores.comm * 0.3) + (scores.trust * 0.2));

  // 六獸語感
  const A = SEX_BEAST_TONE[aBeast] || { vibe:"中性", lead:"彼此協作", kink:"溫和互動" };
  const B = SEX_BEAST_TONE[bBeast] || A;

  // 六親/地支風味
  const kinA = SEX_KIN_DYNAMICS[aKin] || "";
  const kinB = SEX_KIN_DYNAMICS[bKin] || "";
  const brA  = BRANCH_FLAVOR[aBranch] || "";
  const brB  = BRANCH_FLAVOR[bBranch] || "";

  // 三幕劇腳本
  const openLine = (who, beast, branch) => {
    const tone = SEX_BEAST_TONE[beast]?.vibe || "中性";
    const br   = BRANCH_FLAVOR[branch]?.replace(/^偏.|純./,'') || "氛圍";
    return `${who}以${tone}開場，場域先鋪上「${br}」的味道，彼此呼吸逐步對齊。`;
  };
  const midLine = () => {
    if (spice >= 75) {
      return "主段節奏改用『兩快一慢』與「停頓凝視」交替，語言與肢體同時上線，熱度層層疊高。";
    } else if (spice >= 60) {
      return "主段採『遞增式』推進：每三個循環增加一點力度或密度，維持對話可中途微調。";
    } else {
      return "主段以『長呼吸＋長逗留』為主，避免一次加太多變化，確保身心都跟得上。";
    }
  };
  const closeLine = () => {
    if (control >= 70) {
      return "收束以『回到擁抱→口頭回饋→下次想嘗試一件新元素』結尾，讓安全與信任鎖定。";
    } else {
      return "收束改為『安靜相貼 2 分鐘→喝水→簡短交流 3 句』，避免過度檢討打壞餘韻。";
    }
  };

  // 角色傾向
  const roleA = A.lead;
  const roleB = B.lead;
  const kinkA = A.kink;
  const kinkB = B.kink;

  // 任務卡
  const tasks = [];
  if (scores.comm < 60) tasks.push("設定安全詞（綠/黃/紅）與『停手手勢』，任何時刻可啟動。");
  if (scores.pace < 60) tasks.push("用『3 段式節奏』：暖身 4 分鐘 → 高峰 6 分鐘 → 收束 3 分鐘。");
  if (scores.trust < 60) tasks.push("先做非性向親密：互相按摩肩頸 3 分鐘，建立身體信任。");
  if (scores.account < 60) tasks.push("事前說明『可以/不可以/暫不確定』清單，各列 3 點。");
  if (scores.innov < 60) tasks.push("採『一新一熟』原則：這次只加入 1 個新元素（例如：遮眼/語音指令/音樂節拍）。");
  if (!tasks.length) tasks.push("維持當前配方，微調 1 個元素即可（如：音量、光線或節拍）。");

  // 風險
  const risks = [];
  if (mode === 'double' && (aKin === '官鬼' || bKin === '官鬼')) risks.push("權力張力強：務必先說好邊界與撤退條件。");
  if (aBeast === '白虎' || bBeast === '白虎') risks.push("主導傾向高：注意對方回饋，不要一路加壓。");
  if (aBeast === '朱雀' || bBeast === '朱雀') risks.push("語言強度高：避免羞辱與貼標籤，改用描述式語言。");
  if (scores.pace <= 45) risks.push("節奏過急：容易失去身體回應；請把『停頓＋呼吸』放進每個循環。");
  if (!risks.length) risks.push("整體風險低：照既定節奏前進即可。");

  const title = scene === 'sex' ? '性愛深度分析' :
                scene === 'relationship' ? '關係深度分析' : '互動深度分析';

  // 組裝輸出
  const div = document.createElement('div');
  div.className = "space-y-4";

  const pairText = mode === 'single'
    ? `我方：${aBeast} × ${aKin} × ${aBranch}（${brA}）`
    : `我方：${aBeast} × ${aKin} × ${aBranch}（${brA}）｜對方：${bBeast} × ${bKin} × ${bBranch}（${brB}）`;

  const strengths = Object.entries(scores).filter(([k,v])=>v>=70).map(([k])=>labelMap[k]).join('、') || '尚待養成';
  const weaknesses = Object.entries(scores).filter(([k,v])=>v<50).map(([k])=>labelMap[k]).join('、') || '無明顯弱項';

  div.innerHTML = `
    <h3 class="font-bold text-pink-600">${title}</h3>
    <p class="text-sm text-gray-600">${pairText}</p>

    <div class="grid grid-cols-2 gap-3 text-sm">
      <div class="p-3 rounded border bg-white">
        <div><b>情愛指數：</b>${loveIdx}/100</div>
        <div><b>辛香度（刺激）：</b>${spice}/100</div>
        <div><b>掌控度（規則/界線）：</b>${control}/100</div>
      </div>
      <div class="p-3 rounded border bg-white">
        <div><b>優勢面：</b>${strengths}</div>
        <div><b>風險面：</b>${weaknesses}</div>
      </div>
    </div>

    <div class="p-3 rounded border bg-white">
      <div class="font-semibold text-pink-700 mb-1">六獸語感</div>
      <ul class="list-disc pl-5 space-y-1 text-sm">
        <li><b>我方（${aBeast}）</b>：${A.vibe}；傾向${roleA}；偏好 ${kinkA}。</li>
        ${mode==='double' ? `<li><b>對方（${bBeast}）</b>：${B.vibe}；傾向${roleB}；偏好 ${kinkB}。</li>` : ''}
        <li><b>六親風格</b>：${kinA}${mode==='double' ? `｜${kinB}`:''}</li>
      </ul>
    </div>

    <div class="p-3 rounded border border-pink-200 bg-white">
      <div class="font-semibold text-pink-700 mb-1">三幕劇：故事化互動腳本</div>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6">
        <li>${openLine("開場", aBeast, aBranch)} ${mode==='double' ? openLine("對方則", bBeast, bBranch) : ""}</li>
        <li>${midLine()}</li>
        <li>${closeLine()}</li>
      </ol>
    </div>

    ${paceOn ? `
    <div class="p-3 rounded border bg-white">
      <div class="font-semibold text-gray-700 mb-1">節奏建議（已開啟）</div>
      <p class="text-sm">採用「暖身→主段→收束」三段式；每段都保留『停頓 3 秒＋深呼吸 3 次』的回看點。</p>
    </div>` : ''}

    ${contextText ? `
    <div class="p-3 rounded border bg-white">
      <div class="font-semibold text-gray-700 mb-1">你的補充/界線</div>
      <p class="text-sm whitespace-pre-wrap">${escapeHTML(contextText)}</p>
    </div>` : ''}

    <div class="p-3 rounded border bg-white">
      <div class="font-semibold text-gray-700 mb-1">精準任務卡（可直接操作）</div>
      <ul class="list-disc pl-5 space-y-1 text-sm">
        ${tasks.map(t=>`<li>${t}</li>`).join('')}
      </ul>
    </div>

    <div class="p-3 rounded border bg-white">
      <div class="font-semibold text-gray-700 mb-1">可能地雷</div>
      <ul class="list-disc pl-5 space-y-1 text-sm">
        ${risks.map(r=>`<li>${r}</li>`).join('')}
      </ul>
    </div>
  `;

  return div;
}
