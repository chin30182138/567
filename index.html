async function performAnalysis() {
      const payload = getSelections();
      updateChips(payload);

      let isValid = false;

      if (payload.mode === 'personality') {
          isValid = (payload.aBeast && payload.aKin && payload.aBranch);
          if (!isValid) { alert('個性分析：請先選滿我方「六獸、六親、地支」'); return; }
      } else if (payload.mode === 'single') {
        isValid = (payload.aBeast && payload.aKin && payload.aBranch && payload.context);
        if (!isValid) { alert('單人分析：請先選滿我方「六獸、六親、地支」與情境'); return; }
      } else { // dual
        isValid = (payload.aBeast && payload.aKin && payload.aBranch && payload.bBeast && payload.bKin && payload.bBranch && payload.context);
        if (!isValid) { alert('雙人分析：請先選滿我方/對方「六獸、六親、地支」與情境'); return; }
      }

      $('#status').textContent = '分析中…'; $('#result').innerHTML = ''; $('#chartContainer').innerHTML = ''; // 清空圖表容器
      try {
        const res = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`API Request Failed: ${res.status} ${res.statusText} - ${errorText}`);
        }

        const data = await res.json();
        // --- 核心修改點在這裡 ---
        const plain = data.text || "未能獲取分析結果。"; // 現在它會正確地讀取 'text' 鍵的值
        // --- 核心修改點結束 ---

        const formatted = formatOutputWithJson(plain);
        $('#result').innerHTML = formatted.html + formatted.tagsHTML;
        renderRadar(formatted.scores);
        $('#status').textContent = '✅ 完成';
      } catch (e) {
          $('#status').textContent = `❌ 失敗: ${e.message || e}`;
          $('#result').textContent = `分析時發生錯誤，請檢查主控台訊息。錯誤詳情：${e.message || e}`;
          console.error("Analysis failed:", e);
      }
    }
