<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å…­ç¸å…­è¦ªÃ—åœ°æ”¯ åˆ†æå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    select, input, button { margin: 5px; padding: 5px; }
    #result { white-space: pre-line; margin-top: 20px; }
    #encourageBox {
      margin-top: 10px; padding: 10px;
      border: 1px solid #bbf7d0; background: #f0fdf4;
      color: #065f46; font-size: 16px; border-radius: 8px;
    }
    canvas { margin-top: 20px; max-width: 500px; }
  </style>
</head>
<body>
  <h1>å…­ç¸å…­è¦ªÃ—åœ°æ”¯ åˆ†æå™¨</h1>

  <label><input type="checkbox" id="singleMode" checked> å–®æ–¹åˆ†æ</label>
  <label><input type="checkbox" id="dryMode" checked> æ¸¬è©¦æ¨¡å¼ (dry)</label>
  <br>

  <h3>æˆ‘æ–¹</h3>
  å…­ç¸:
  <select id="aBeast">
    <option>é’é¾</option><option>æœ±é›€</option><option>ç™½è™</option>
    <option>ç„æ­¦</option><option>å‹¾é™³</option><option>é¨°è›‡</option>
  </select>
  å…­è¦ª:
  <select id="aKin">
    <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å¦»è²¡</option>
    <option>å®˜é¬¼</option><option>å­å­«</option>
  </select>
  åœ°æ”¯:
  <select id="aBranch">
    <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
    <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
    <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
  </select>

  <div id="pairInputs">
    <h3>å°æ–¹</h3>
    å…­ç¸:
    <select id="bBeast">
      <option>é’é¾</option><option>æœ±é›€</option><option>ç™½è™</option>
      <option>ç„æ­¦</option><option>å‹¾é™³</option><option>é¨°è›‡</option>
    </select>
    å…­è¦ª:
    <select id="bKin">
      <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å¦»è²¡</option>
      <option>å®˜é¬¼</option><option>å­å­«</option>
    </select>
    åœ°æ”¯:
    <select id="bBranch">
      <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
      <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
      <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
    </select>
  </div>

  <h3>æƒ…å¢ƒ</h3>
  <input type="text" id="context" placeholder="ä¾‹å¦‚ï¼šæ„›æƒ… / è·å ´ / å®¶åº­">
  <br><br>

  <button id="go">ä¸€éµåˆ†æ</button>
  <button id="print">åˆ—å° / åŒ¯å‡º PDF</button>
  <button id="save">å­˜æª”</button>
  <button id="export">åŒ¯å‡º JSON</button>

  <div id="result"></div>
  <div id="encourageBox" class="hidden"></div>
  <canvas id="radarChart"></canvas>

  <script>
    // ğŸ”¹ å·¥å…·
    function getApiUrl() {
      return '/api/analyze'; // å¦‚æœä½ è¦å›ºå®š domainï¼Œå¯æ”¹æˆ https://xxx.vercel.app/api/analyze
    }
    function getSelections() {
      return {
        aBeast: document.getElementById('aBeast').value,
        aKin: document.getElementById('aKin').value,
        aBranch: document.getElementById('aBranch').value,
        bBeast: document.getElementById('bBeast').value,
        bKin: document.getElementById('bKin').value,
        bBranch: document.getElementById('bBranch').value,
        context: document.getElementById('context').value,
        mode: document.getElementById('singleMode').checked ? 'single' : 'pair',
        dry: document.getElementById('dryMode').checked
      };
    }

    // ğŸ”¹ æ ¼å¼åŒ–è¼¸å‡º
    function formatOutputWithJson(text) {
      let scores = null, encourage = "", html = text;
      const match = text.match(/```json([\\s\\S]*?)```/);
      if (match) {
        try {
          const obj = JSON.parse(match[1]);
          scores = obj.scores || null;
          encourage = obj.encourage || "";
        } catch(e) {}
      }
      return { html, scores, encourage };
    }

    // ğŸ”¹ ç•«é›·é”åœ–
    function drawRadar(scores) {
      const ctx = document.getElementById('radarChart');
      if (window.radarChart) window.radarChart.destroy();
      window.radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['fit','comm','pace','account','trust','innov'],
          datasets: [{
            label: 'å…­ç¶­åº¦',
            data: [scores.fit, scores.comm, scores.pace, scores.account, scores.trust, scores.innov],
            backgroundColor: 'rgba(34,197,94,0.2)',
            borderColor: 'rgba(34,197,94,1)'
          }]
        },
        options: { scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
      });
    }

    // ğŸ”¹ ä¸€éµåˆ†æ
    async function runAnalyze() {
      const sel = getSelections();
      const url = sel.dry ? getApiUrl() + '?dry=1&mode=' + sel.mode : getApiUrl();
      const payload = sel.dry ? null : JSON.stringify(sel);

      const res = await fetch(url, {
        method: sel.dry ? 'GET' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload
      });
      const data = await res.json();
      const formatted = formatOutputWithJson(data.text);

      document.getElementById('result').innerText = formatted.html;
      if (formatted.encourage) {
        document.getElementById('encourageBox').classList.remove('hidden');
        document.getElementById('encourageBox').innerText = formatted.encourage;
      }
      if (formatted.scores) drawRadar(formatted.scores);
    }

    // ğŸ”¹ åˆ—å° / å­˜æª” / åŒ¯å‡º
    document.getElementById('print').addEventListener('click', function() {
      const sel = getSelections();
      const chartImg = (window.radarChart && window.radarChart.canvas)
        ? window.radarChart.canvas.toDataURL('image/png')
        : '';
      const encText = document.getElementById('encourageBox').innerText;

      const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>åˆ—å°</title>
</head>
<body>
  <h1>å…­ç¸å…­è¦ªÃ—åœ°æ”¯ åˆ†æï¼ˆåˆ—å°ç‰ˆï¼‰</h1>
  <p>ç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString()}</p>
  <div>${document.getElementById('result').innerHTML}</div>
  ${encText ? `<div style="color:green">${encText}</div>` : ""}
  ${chartImg ? `<div><img src="${chartImg}" style="max-width:500px"></div>` : ""}
</body>
</html>
`;

      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if (!w) return;
      setTimeout(() => { w.print(); URL.revokeObjectURL(url); }, 500);
    });

    document.getElementById('save').addEventListener('click', function() {
      const snap = { ts: Date.now(), result: document.getElementById('result').innerHTML };
      localStorage.setItem('analysis', JSON.stringify(snap));
      alert("å·²å­˜æª”");
    });

    document.getElementById('export').addEventListener('click', function() {
      const snap = { ts: Date.now(), result: document.getElementById('result').innerHTML };
      const blob = new Blob([JSON.stringify(snap, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'analysis.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('go').addEventListener('click', runAnalyze);
  </script>
</body>
</html>
