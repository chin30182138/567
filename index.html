<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>六獸六親×地支 分析器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    select, input, button { margin: 5px; padding: 5px; }
    #result { white-space: pre-line; margin-top: 20px; }
    #encourageBox {
      margin-top: 10px; padding: 10px;
      border: 1px solid #bbf7d0; background: #f0fdf4;
      color: #065f46; font-size: 16px; border-radius: 8px;
    }
    canvas { margin-top: 20px; max-width: 500px; }
  </style>
</head>
<body>
  <h1>六獸六親×地支 分析器</h1>

  <label><input type="checkbox" id="singleMode" checked> 單方分析</label>
  <label><input type="checkbox" id="dryMode" checked> 測試模式 (dry)</label>
  <br>

  <h3>我方</h3>
  六獸:
  <select id="aBeast">
    <option>青龍</option><option>朱雀</option><option>白虎</option>
    <option>玄武</option><option>勾陳</option><option>騰蛇</option>
  </select>
  六親:
  <select id="aKin">
    <option>父母</option><option>兄弟</option><option>妻財</option>
    <option>官鬼</option><option>子孫</option>
  </select>
  地支:
  <select id="aBranch">
    <option>子</option><option>丑</option><option>寅</option><option>卯</option>
    <option>辰</option><option>巳</option><option>午</option><option>未</option>
    <option>申</option><option>酉</option><option>戌</option><option>亥</option>
  </select>

  <div id="pairInputs">
    <h3>對方</h3>
    六獸:
    <select id="bBeast">
      <option>青龍</option><option>朱雀</option><option>白虎</option>
      <option>玄武</option><option>勾陳</option><option>騰蛇</option>
    </select>
    六親:
    <select id="bKin">
      <option>父母</option><option>兄弟</option><option>妻財</option>
      <option>官鬼</option><option>子孫</option>
    </select>
    地支:
    <select id="bBranch">
      <option>子</option><option>丑</option><option>寅</option><option>卯</option>
      <option>辰</option><option>巳</option><option>午</option><option>未</option>
      <option>申</option><option>酉</option><option>戌</option><option>亥</option>
    </select>
  </div>

  <h3>情境</h3>
  <input type="text" id="context" placeholder="例如：愛情 / 職場 / 家庭">
  <br><br>

  <button id="go">一鍵分析</button>
  <button id="print">列印 / 匯出 PDF</button>
  <button id="save">存檔</button>
  <button id="export">匯出 JSON</button>

  <div id="result"></div>
  <div id="encourageBox" class="hidden"></div>
  <canvas id="radarChart"></canvas>

  <script>
    // 🔹 工具
    function getApiUrl() {
      return '/api/analyze'; // 如果你要固定 domain，可改成 https://xxx.vercel.app/api/analyze
    }
    function getSelections() {
      return {
        aBeast: document.getElementById('aBeast').value,
        aKin: document.getElementById('aKin').value,
        aBranch: document.getElementById('aBranch').value,
        bBeast: document.getElementById('bBeast').value,
        bKin: document.getElementById('bKin').value,
        bBranch: document.getElementById('bBranch').value,
        context: document.getElementById('context').value,
        mode: document.getElementById('singleMode').checked ? 'single' : 'pair',
        dry: document.getElementById('dryMode').checked
      };
    }

    // 🔹 格式化輸出
    function formatOutputWithJson(text) {
      let scores = null, encourage = "", html = text;
      const match = text.match(/```json([\\s\\S]*?)```/);
      if (match) {
        try {
          const obj = JSON.parse(match[1]);
          scores = obj.scores || null;
          encourage = obj.encourage || "";
        } catch(e) {}
      }
      return { html, scores, encourage };
    }

    // 🔹 畫雷達圖
    function drawRadar(scores) {
      const ctx = document.getElementById('radarChart');
      if (window.radarChart) window.radarChart.destroy();
      window.radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['fit','comm','pace','account','trust','innov'],
          datasets: [{
            label: '六維度',
            data: [scores.fit, scores.comm, scores.pace, scores.account, scores.trust, scores.innov],
            backgroundColor: 'rgba(34,197,94,0.2)',
            borderColor: 'rgba(34,197,94,1)'
          }]
        },
        options: { scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
      });
    }

    // 🔹 一鍵分析
    async function runAnalyze() {
      const sel = getSelections();
      const url = sel.dry ? getApiUrl() + '?dry=1&mode=' + sel.mode : getApiUrl();
      const payload = sel.dry ? null : JSON.stringify(sel);

      const res = await fetch(url, {
        method: sel.dry ? 'GET' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload
      });
      const data = await res.json();
      const formatted = formatOutputWithJson(data.text);

      document.getElementById('result').innerText = formatted.html;
      if (formatted.encourage) {
        document.getElementById('encourageBox').classList.remove('hidden');
        document.getElementById('encourageBox').innerText = formatted.encourage;
      }
      if (formatted.scores) drawRadar(formatted.scores);
    }

    // 🔹 列印 / 存檔 / 匯出
    document.getElementById('print').addEventListener('click', function() {
      const sel = getSelections();
      const chartImg = (window.radarChart && window.radarChart.canvas)
        ? window.radarChart.canvas.toDataURL('image/png')
        : '';
      const encText = document.getElementById('encourageBox').innerText;

      const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>列印</title>
</head>
<body>
  <h1>六獸六親×地支 分析（列印版）</h1>
  <p>產生時間：${new Date().toLocaleString()}</p>
  <div>${document.getElementById('result').innerHTML}</div>
  ${encText ? `<div style="color:green">${encText}</div>` : ""}
  ${chartImg ? `<div><img src="${chartImg}" style="max-width:500px"></div>` : ""}
</body>
</html>
`;

      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if (!w) return;
      setTimeout(() => { w.print(); URL.revokeObjectURL(url); }, 500);
    });

    document.getElementById('save').addEventListener('click', function() {
      const snap = { ts: Date.now(), result: document.getElementById('result').innerHTML };
      localStorage.setItem('analysis', JSON.stringify(snap));
      alert("已存檔");
    });

    document.getElementById('export').addEventListener('click', function() {
      const snap = { ts: Date.now(), result: document.getElementById('result').innerHTML };
      const blob = new Blob([JSON.stringify(snap, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'analysis.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('go').addEventListener('click', runAnalyze);
  </script>
</body>
</html>
